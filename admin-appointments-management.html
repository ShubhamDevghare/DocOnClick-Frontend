<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Appointments Management - DocOnClick</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #f8fafc;
            color: #1a202c;
        }

        .admin-container {
            display: flex;
            min-height: 100vh;
        }

        /* Sidebar Styles */
        .sidebar {
            width: 280px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 0;
            position: fixed;
            height: 100vh;
            overflow-y: auto;
            z-index: 1000;
        }

        .sidebar-header {
            padding: 2rem 1.5rem;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .sidebar-header h2 {
            font-size: 1.5rem;
            margin-bottom: 1rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .admin-info {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }

        .role-badge {
            background: rgba(255, 255, 255, 0.2);
            padding: 0.25rem 0.75rem;
            border-radius: 1rem;
            font-size: 0.75rem;
            width: fit-content;
        }

        .nav-menu {
            list-style: none;
            padding: 1rem 0;
        }

        .nav-menu li {
            margin: 0;
        }

        .nav-menu a {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            padding: 1rem 1.5rem;
            color: rgba(255, 255, 255, 0.8);
            text-decoration: none;
            transition: all 0.3s ease;
            border-left: 3px solid transparent;
        }

        .nav-menu a:hover,
        .nav-menu a.active {
            background: rgba(255, 255, 255, 0.1);
            color: white;
            border-left-color: #fbbf24;
        }

        /* Main Content */
        .main-content {
            flex: 1;
            margin-left: 280px;
            padding: 2rem;
        }

        .content-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 2rem;
            padding-bottom: 1rem;
            border-bottom: 2px solid #e2e8f0;
        }

        .content-header h1 {
            font-size: 2rem;
            color: #1a202c;
        }

        .header-actions {
            display: flex;
            gap: 1rem;
        }

        /* Button Styles */
        .btn {
            padding: 0.75rem 1.5rem;
            border: none;
            border-radius: 0.5rem;
            cursor: pointer;
            font-size: 0.875rem;
            font-weight: 500;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            transition: all 0.3s ease;
        }

        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            pointer-events: none;
        }

        .btn-primary {
            background: #2563eb;
            color: white;
        }

        .btn-primary:hover:not(:disabled) {
            background: #1d4ed8;
            transform: translateY(-1px);
        }

        .btn-secondary {
            background: #6b7280;
            color: white;
        }

        .btn-secondary:hover:not(:disabled) {
            background: #4b5563;
        }

        .btn-warning {
            background: #f59e0b;
            color: white;
        }

        .btn-warning:hover:not(:disabled) {
            background: #d97706;
        }

        .btn-danger {
            background: #dc2626;
            color: white;
        }

        .btn-danger:hover:not(:disabled) {
            background: #b91c1c;
        }

        .btn-outline {
            background: transparent;
            color: #6b7280;
            border: 1px solid #d1d5db;
        }

        .btn-outline:hover:not(:disabled) {
            background: #f9fafb;
            border-color: #9ca3af;
        }

        .btn-sm {
            padding: 0.5rem 1rem;
            font-size: 0.75rem;
        }

        /* Search and Filter Section */
        .search-filter-section {
            background: white;
            padding: 1.5rem;
            border-radius: 0.75rem;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
            margin-bottom: 2rem;
        }

        .search-group,
        .filter-group {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1rem;
            margin-bottom: 1rem;
        }

        .filter-group {
            margin-bottom: 0;
        }

        .form-group {
            display: flex;
            flex-direction: column;
        }

        .form-group label {
            font-weight: 500;
            margin-bottom: 0.5rem;
            color: #374151;
        }

        .form-control {
            padding: 0.75rem;
            border: 1px solid #d1d5db;
            border-radius: 0.5rem;
            font-size: 0.875rem;
            transition: border-color 0.3s ease;
        }

        .form-control:focus {
            outline: none;
            border-color: #2563eb;
            box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
        }

        /* Table Styles */
        .table-container {
            background: white;
            border-radius: 0.75rem;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
            overflow: hidden;
            margin-bottom: 2rem;
        }

        .table {
            width: 100%;
            border-collapse: collapse;
        }

        .table th,
        .table td {
            padding: 1rem;
            text-align: left;
            border-bottom: 1px solid #e2e8f0;
        }

        .table th {
            background: #f8fafc;
            font-weight: 600;
            color: #374151;
        }

        .table tbody tr:hover {
            background: #f8fafc;
        }

        .loading {
            text-align: center;
            padding: 3rem;
            color: #6b7280;
        }

        .spinner {
            border: 3px solid #f3f4f6;
            border-top: 3px solid #2563eb;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            animation: spin 1s linear infinite;
            margin: 0 auto 1rem;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Status Badges */
        .status-badge {
            padding: 0.25rem 0.75rem;
            border-radius: 1rem;
            font-size: 0.75rem;
            font-weight: 500;
            text-transform: uppercase;
        }

        .status-confirmed {
            background: #dcfce7;
            color: #166534;
        }

        .status-completed {
            background: #dbeafe;
            color: #1e40af;
        }

        .status-cancelled {
            background: #fee2e2;
            color: #991b1b;
        }

        .status-pending {
            background: #fef3c7;
            color: #92400e;
        }

        .payment-paid {
            background: #dcfce7;
            color: #166534;
        }

        .payment-unpaid {
            background: #fee2e2;
            color: #991b1b;
        }

        /* Actions */
        .actions {
            display: flex;
            gap: 0.5rem;
            flex-wrap: wrap;
        }

        /* Pagination */
        .pagination {
            display: flex;
            justify-content: center;
            gap: 0.5rem;
            margin-top: 2rem;
        }

        .pagination button {
            padding: 0.5rem 1rem;
            border: 1px solid #d1d5db;
            background: white;
            color: #374151;
            border-radius: 0.375rem;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .pagination button:hover:not(:disabled) {
            background: #f9fafb;
            border-color: #9ca3af;
        }

        .pagination button.active {
            background: #2563eb;
            color: white;
            border-color: #2563eb;
        }

        .pagination button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        /* Modal Styles */
        .modal {
            display: none;
            position: fixed;
            z-index: 2000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(4px);
        }

        .modal-content {
            background-color: white;
            margin: 2% auto;
            padding: 0;
            border-radius: 0.75rem;
            width: 90%;
            max-width: 1200px;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1.5rem 2rem;
            border-bottom: 1px solid #e2e8f0;
            background: #f8fafc;
            border-radius: 0.75rem 0.75rem 0 0;
        }

        .modal-header h2 {
            margin: 0;
            color: #1a202c;
        }

        .close {
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: #6b7280;
            padding: 0.5rem;
            border-radius: 0.375rem;
            transition: all 0.3s ease;
        }

        .close:hover {
            background: #e5e7eb;
            color: #374151;
        }

        .modal-body {
            padding: 2rem;
        }

        /* Booking Modal Specific Styles */
        .booking-modal .modal-content {
            max-width: 1000px;
        }

        .booking-steps {
            display: flex;
            justify-content: space-between;
            margin-bottom: 2rem;
            padding: 1rem;
            background: #f8fafc;
            border-radius: 0.5rem;
        }

        .step {
            display: flex;
            flex-direction: column;
            align-items: center;
            flex: 1;
            position: relative;
        }

        .step:not(:last-child)::after {
            content: '';
            position: absolute;
            top: 15px;
            right: -50%;
            width: 100%;
            height: 2px;
            background: #e2e8f0;
            z-index: 1;
        }

        .step.completed:not(:last-child)::after {
            background: #10b981;
        }

        .step-number {
            width: 30px;
            height: 30px;
            border-radius: 50%;
            background: #e2e8f0;
            color: #6b7280;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            margin-bottom: 0.5rem;
            position: relative;
            z-index: 2;
        }

        .step.active .step-number {
            background: #2563eb;
            color: white;
        }

        .step.completed .step-number {
            background: #10b981;
            color: white;
        }

        .step-title {
            font-size: 0.75rem;
            text-align: center;
            color: #6b7280;
        }

        .step.active .step-title {
            color: #2563eb;
            font-weight: 600;
        }

        .step.completed .step-title {
            color: #10b981;
        }

        .step-content {
            display: none;
            min-height: 400px;
        }

        .step-content.active {
            display: block;
        }

        .step-navigation {
            display: flex;
            justify-content: space-between;
            margin-top: 2rem;
            padding-top: 1rem;
            border-top: 1px solid #e2e8f0;
        }

        /* Doctor Selection Styles */
        .search-doctor {
            margin-bottom: 1rem;
        }

        .filters {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            margin-bottom: 2rem;
        }

        .doctor-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 1rem;
            max-height: 400px;
            overflow-y: auto;
        }

        .doctor-card {
            border: 2px solid #e2e8f0;
            border-radius: 0.75rem;
            padding: 1rem;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .doctor-card:hover {
            border-color: #2563eb;
            box-shadow: 0 4px 12px rgba(37, 99, 235, 0.15);
        }

        .doctor-card.selected {
            border-color: #2563eb;
            background: #eff6ff;
        }

        .doctor-header {
            display: flex;
            align-items: center;
            gap: 1rem;
            margin-bottom: 1rem;
        }

        .doctor-avatar {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background: #2563eb;
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            font-size: 1.25rem;
        }

        .doctor-info h3 {
            margin: 0 0 0.25rem 0;
            color: #1a202c;
        }

        .doctor-info p {
            margin: 0;
            color: #6b7280;
            font-size: 0.875rem;
        }

        .doctor-details {
            display: flex;
            flex-direction: column;
            gap: 0.25rem;
            font-size: 0.875rem;
            color: #6b7280;
        }

        .doctor-rating {
            display: flex;
            align-items: center;
            gap: 0.25rem;
            color: #f59e0b;
        }

        /* Calendar Styles */
        .calendar-container {
            display: grid;
            grid-template-columns: 1fr 300px;
            gap: 2rem;
        }

        .calendar {
            border: 1px solid #e2e8f0;
            border-radius: 0.75rem;
            overflow: hidden;
        }

        .calendar-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1rem;
            background: #f8fafc;
            border-bottom: 1px solid #e2e8f0;
        }

        .calendar-nav {
            background: none;
            border: none;
            padding: 0.5rem;
            cursor: pointer;
            border-radius: 0.375rem;
            transition: background 0.3s ease;
        }

        .calendar-nav:hover {
            background: #e5e7eb;
        }

        .calendar-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
        }

        .calendar-day-header {
            padding: 0.75rem;
            text-align: center;
            font-weight: 600;
            background: #f8fafc;
            border-bottom: 1px solid #e2e8f0;
            font-size: 0.875rem;
            color: #6b7280;
        }

        .calendar-day {
            padding: 0.75rem;
            text-align: center;
            cursor: pointer;
            border-bottom: 1px solid #f3f4f6;
            border-right: 1px solid #f3f4f6;
            transition: all 0.3s ease;
            min-height: 50px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .calendar-day:hover:not(.disabled) {
            background: #eff6ff;
        }

        .calendar-day.selected {
            background: #2563eb;
            color: white;
        }

        .calendar-day.disabled {
            color: #d1d5db;
            cursor: not-allowed;
        }

        .calendar-day.other-month {
            color: #d1d5db;
        }

        .time-slots {
            max-height: 400px;
            overflow-y: auto;
        }

        .time-slot {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.75rem;
            border: 1px solid #e2e8f0;
            border-radius: 0.5rem;
            margin-bottom: 0.5rem;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .time-slot:hover:not(.disabled) {
            border-color: #2563eb;
            background: #eff6ff;
        }

        .time-slot.selected {
            border-color: #2563eb;
            background: #2563eb;
            color: white;
        }

        .time-slot.disabled {
            background: #f9fafb;
            color: #9ca3af;
            cursor: not-allowed;
        }

        /* Patient Form Styles */
        .patient-search {
            margin-bottom: 2rem;
            position: relative;
        }

        .patient-suggestions {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: white;
            border: 1px solid #e2e8f0;
            border-top: none;
            border-radius: 0 0 0.5rem 0.5rem;
            max-height: 200px;
            overflow-y: auto;
            z-index: 10;
        }

        .patient-suggestion {
            padding: 0.75rem;
            cursor: pointer;
            border-bottom: 1px solid #f3f4f6;
            transition: background 0.3s ease;
        }

        .patient-suggestion:hover {
            background: #f8fafc;
        }

        .patient-suggestion:last-child {
            border-bottom: none;
        }

        .patient-form {
            background: #f8fafc;
            padding: 1.5rem;
            border-radius: 0.75rem;
            border: 1px solid #e2e8f0;
        }

        .form-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1rem;
            margin-bottom: 1rem;
        }

        /* File Upload Styles */
        .file-upload-area {
            border: 2px dashed #d1d5db;
            border-radius: 0.75rem;
            padding: 3rem;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-bottom: 2rem;
        }

        .file-upload-area:hover {
            border-color: #2563eb;
            background: #eff6ff;
        }

        .file-upload-area.dragover {
            border-color: #2563eb;
            background: #eff6ff;
        }

        .uploaded-files {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
            margin-bottom: 1rem;
        }

        .uploaded-file {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1rem;
            background: #f8fafc;
            border: 1px solid #e2e8f0;
            border-radius: 0.5rem;
        }

        .file-info {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .file-icon {
            width: 40px;
            height: 40px;
            background: #2563eb;
            color: white;
            border-radius: 0.5rem;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        /* Payment Styles */
        .payment-summary {
            background: #f8fafc;
            padding: 1.5rem;
            border-radius: 0.75rem;
            border: 1px solid #e2e8f0;
            margin-bottom: 2rem;
        }

        .payment-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.5rem 0;
            border-bottom: 1px solid #e2e8f0;
        }

        .payment-item:last-child {
            border-bottom: none;
        }

        .payment-total {
            font-weight: 600;
            font-size: 1.125rem;
            color: #1a202c;
            border-top: 2px solid #e2e8f0;
            margin-top: 0.5rem;
            padding-top: 1rem;
        }

        /* Confirmation Styles */
        .confirmation-content {
            text-align: center;
        }

        .success-icon {
            width: 80px;
            height: 80px;
            background: #10b981;
            color: white;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 2rem;
            margin: 0 auto 2rem;
        }

        /* Detail Grid */
        .detail-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1rem;
            margin-bottom: 1rem;
        }

        .detail-item {
            display: flex;
            flex-direction: column;
            gap: 0.25rem;
        }

        .detail-label {
            font-weight: 600;
            color: #6b7280;
            font-size: 0.875rem;
        }

        .detail-value {
            color: #1a202c;
        }

        /* File Display Styles */
        .file-display {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1rem;
            background: #f8fafc;
            border: 1px solid #e2e8f0;
            border-radius: 0.5rem;
            margin-bottom: 0.5rem;
        }

        .file-display .file-info {
            display: flex;
            align-items: center;
            gap: 1rem;
            flex: 1;
        }

        .file-display .file-details {
            display: flex;
            flex-direction: column;
            gap: 0.25rem;
        }

        .file-display .file-name {
            font-weight: 600;
            color: #1a202c;
        }

        .file-display .file-meta {
            font-size: 0.875rem;
            color: #6b7280;
        }

        /* Alerts */
        .alert {
            padding: 1rem 1.5rem;
            border-radius: 0.5rem;
            margin-bottom: 1rem;
            position: fixed;
            top: 2rem;
            right: 2rem;
            z-index: 3000;
            min-width: 300px;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.15);
        }

        .alert-success {
            background: #dcfce7;
            color: #166534;
            border: 1px solid #bbf7d0;
        }

        .alert-error {
            background: #fee2e2;
            color: #991b1b;
            border: 1px solid #fecaca;
        }

        /* Responsive Design */
        @media (max-width: 768px) {
            .sidebar {
                width: 100%;
                height: auto;
                position: relative;
            }

            .main-content {
                margin-left: 0;
                padding: 1rem;
            }

            .content-header {
                flex-direction: column;
                gap: 1rem;
                align-items: flex-start;
            }

            .header-actions {
                width: 100%;
                justify-content: flex-start;
            }

            .search-group,
            .filter-group {
                grid-template-columns: 1fr;
            }

            .calendar-container {
                grid-template-columns: 1fr;
            }

            .doctor-grid {
                grid-template-columns: 1fr;
            }

            .form-row {
                grid-template-columns: 1fr;
            }

            .detail-grid {
                grid-template-columns: 1fr;
            }

            .modal-content {
                width: 95%;
                margin: 5% auto;
            }

            .booking-steps {
                flex-wrap: wrap;
                gap: 1rem;
            }

            .step {
                flex: none;
                width: calc(50% - 0.5rem);
            }

            .step:nth-child(odd):not(:last-child)::after {
                display: none;
            }
        }
    </style>
</head>
<body>
    <div class="admin-container">
        <!-- Sidebar -->
        <nav class="sidebar">
            <div class="sidebar-header">
                <h2><i class="fas fa-user-shield"></i> Admin Panel</h2>
                <div class="admin-info">
                    <span id="adminName">Admin User</span>
                    <span id="adminRole" class="role-badge">SUPER_ADMIN</span>
                </div>
            </div>
            
            <ul class="nav-menu">
                <li><a href="admin-dashboard.html"><i class="fas fa-tachometer-alt"></i> Dashboard</a></li>
                <li><a href="admin-doctor-management.html"><i class="fas fa-user-md"></i> Doctor Management</a></li>
                <li><a href="admin-user-management.html"><i class="fas fa-users"></i> User Management</a></li>
                <li><a href="admin-patient-management.html"><i class="fas fa-user-injured"></i> Patient Management</a></li>
                <li><a href="admin-appointments-management.html" class="active"><i class="fas fa-calendar-check"></i> Appointments</a></li>
                <li><a href="admin-admin-management.html"><i class="fas fa-user-shield"></i> Admin Management</a></li>
                <li><a href="admin-payments-management.html"><i class="fas fa-credit-card"></i> Payments</a></li>
                <li><a href="#" onclick="logout()"><i class="fas fa-sign-out-alt"></i> Logout</a></li>
            </ul>
        </nav>

        <!-- Main Content -->
        <main class="main-content">
            <header class="content-header">
                <h1>Appointments Management</h1>
                <div class="header-actions">
                    <button class="btn btn-primary" onclick="startBookingFlow()">
                        <i class="fas fa-plus"></i> Book Appointment
                    </button>
                    <button class="btn btn-secondary" onclick="refreshAppointments()">
                        <i class="fas fa-sync-alt"></i> Refresh
                    </button>
                </div>
            </header>

            <!-- Search and Filter Section -->
            <div class="search-filter-section">
                <div class="search-group">
                    <div class="form-group">
                        <label for="searchAppointmentId">Search by Appointment ID</label>
                        <input type="text" id="searchAppointmentId" class="form-control" 
                               placeholder="Enter appointment ID..." onkeyup="handleSearch()">
                    </div>
                    
                    <div class="form-group">
                        <label for="searchPatientName">Search by Patient Name</label>
                        <input type="text" id="searchPatientName" class="form-control" 
                               placeholder="Enter patient name..." onkeyup="handleSearch()">
                    </div>
                </div>
                
                <div class="filter-group">
                    <div class="form-group">
                        <label for="filterDate">Filter by Date</label>
                        <input type="date" id="filterDate" class="form-control" onchange="handleFilter()">
                    </div>
                    
                    <div class="form-group">
                        <label for="filterStatus">Filter by Status</label>
                        <select id="filterStatus" class="form-control" onchange="handleFilter()">
                            <option value="">All Status</option>
                            <option value="CONFIRMED">Confirmed</option>
                            <option value="COMPLETED">Completed</option>
                            <option value="CANCELLED">Cancelled</option>
                            <option value="PENDING">Pending</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label>&nbsp;</label>
                        <button class="btn btn-outline" onclick="clearFilters()">
                            <i class="fas fa-times"></i> Clear Filters
                        </button>
                    </div>
                </div>
            </div>

            <!-- Appointments Table -->
            <div class="table-container">
                <table class="table">
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>Patient</th>
                            <th>Doctor</th>
                            <th>Date & Time</th>
                            <th>Status</th>
                            <th>Payment</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="appointmentsTableBody">
                        <tr>
                            <td colspan="7" class="loading">
                                <div class="spinner"></div>
                                Loading appointments...
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>

            <!-- Pagination -->
            <div class="pagination" id="pagination">
                <!-- Dynamic pagination will be inserted here -->
            </div>
        </main>
    </div>

    <!-- Appointment Details Modal -->
    <div id="appointmentDetailsModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Appointment Details</h2>
                <button class="close" onclick="closeModal('appointmentDetailsModal')">&times;</button>
            </div>
            <div class="modal-body">
                <div id="appointmentDetails"></div>
            </div>
        </div>
    </div>

    <!-- Book Appointment Modal with Multi-Step Flow -->
    <div id="bookAppointmentModal" class="modal booking-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Book Appointment</h2>
                <button class="close" onclick="closeBookingModal()">&times;</button>
            </div>
            <div class="modal-body">
                <!-- Progress Steps -->
                <div class="booking-steps">
                    <div class="step active" id="step1">
                        <div class="step-number">1</div>
                        <div class="step-title">Select Doctor</div>
                    </div>
                    <div class="step" id="step2">
                        <div class="step-number">2</div>
                        <div class="step-title">Schedule</div>
                    </div>
                    <div class="step" id="step3">
                        <div class="step-number">3</div>
                        <div class="step-title">Patient Details</div>
                    </div>
                    <div class="step" id="step4">
                        <div class="step-number">4</div>
                        <div class="step-title">Upload Reports</div>
                    </div>
                    <div class="step" id="step5">
                        <div class="step-number">5</div>
                        <div class="step-title">Confirmation</div>
                    </div>
                    <div class="step" id="step6">
                        <div class="step-number">6</div>
                        <div class="step-title">Payment</div>
                    </div>
                </div>

                <!-- Step 1: Select Doctor -->
                <div id="stepContent1" class="step-content active">
                    <h3>Select Doctor</h3>
                    
                    <div class="search-doctor">
                        <input type="text" id="doctorSearch" class="form-control" 
                               placeholder="Search by doctor name, specialty, or location..." 
                               onkeyup="performSearch()">
                    </div>
                    
                    <div class="filters">
                        <select id="specialtyFilter" class="form-control" onchange="filterDoctors()">
                            <option value="">All Specialties</option>
                        </select>
                        <select id="ratingFilter" class="form-control" onchange="filterDoctors()">
                            <option value="">All Ratings</option>
                            <option value="4">4+ Stars</option>
                            <option value="3">3+ Stars</option>
                        </select>
                        <select id="locationFilter" class="form-control" onchange="filterDoctors()">
                            <option value="">All Locations</option>
                        </select>
                    </div>
                    
                    <div id="doctorsGrid" class="doctor-grid">
                        <!-- Doctors will be loaded here -->
                    </div>
                </div>

                <!-- Step 2: Schedule Appointment -->
                <div id="stepContent2" class="step-content">
                    <h3>Schedule Appointment</h3>
                    
                    <div class="calendar-container">
                        <div class="calendar">
                            <div class="calendar-header">
                                <button class="calendar-nav" onclick="previousMonth()">
                                    <i class="fas fa-chevron-left"></i>
                                </button>
                                <span id="currentMonth"></span>
                                <button class="calendar-nav" onclick="nextMonth()">
                                    <i class="fas fa-chevron-right"></i>
                                </button>
                            </div>
                            <div class="calendar-grid" id="calendarGrid">
                                <!-- Calendar will be generated here -->
                            </div>
                        </div>
                        
                        <div>
                            <h4>Available Time Slots</h4>
                            <div id="timeSlots" class="time-slots">
                                <p>Please select a date to view available time slots</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Step 3: Patient Details -->
                <div id="stepContent3" class="step-content">
                    <h3>Enter Patient Details</h3>
                    
                    <div class="patient-search">
                        <label>Search Existing Patient</label>
                        <div style="position: relative;">
                            <input type="text" id="patientSearchInput" class="form-control" 
                                   placeholder="Search by name or phone number..." 
                                   onkeyup="searchPatients()">
                            <div id="patientSuggestions" class="patient-suggestions" style="display: none;">
                                <!-- Patient suggestions will appear here -->
                            </div>
                        </div>
                    </div>
                    
                    <div style="text-align: center; margin: 1rem 0;">
                        <span>OR</span>
                    </div>
                    
                    <form id="patientForm" class="patient-form">
                        <h4>Add New Patient</h4>
                        
                        <div class="form-row">
                            <div class="form-group">
                                <label for="patientName">Full Name *</label>
                                <input type="text" id="patientName" class="form-control" required>
                            </div>
                            <div class="form-group">
                                <label for="patientGender">Gender *</label>
                                <select id="patientGender" class="form-control" required>
                                    <option value="">Select Gender</option>
                                    <option value="MALE">Male</option>
                                    <option value="FEMALE">Female</option>
                                    <option value="OTHER">Other</option>
                                </select>
                            </div>
                        </div>
                        
                        <div class="form-row">
                            <div class="form-group">
                                <label for="patientDOB">Date of Birth *</label>
                                <input type="date" id="patientDOB" class="form-control" required>
                            </div>
                            <div class="form-group">
                                <label for="patientPhone">Phone Number *</label>
                                <input type="tel" id="patientPhone" class="form-control" 
                                       pattern="[0-9]{10}" required>
                            </div>
                        </div>
                        
                        <div class="form-row">
                            <div class="form-group">
                                <label for="patientEmail">Email Address *</label>
                                <input type="email" id="patientEmail" class="form-control" required>
                            </div>
                        </div>
                        
                        <div class="form-group">
                            <label for="patientAddress">Physical Address *</label>
                            <textarea id="patientAddress" class="form-control" rows="3" required></textarea>
                        </div>
                    </form>
                </div>

                <!-- Step 4: Upload Reports -->
                <div id="stepContent4" class="step-content">
                    <h3>Upload Reports (Optional)</h3>
                    
                    <div class="file-upload-area" onclick="document.getElementById('fileInput').click()">
                        <i class="fas fa-cloud-upload-alt" style="font-size: 3rem; color: var(--primary-color); margin-bottom: 1rem;"></i>
                        <h4>Drag and drop files here or click to browse</h4>
                        <p>Supported formats: PDF, JPG, PNG, TXT (Max 10MB each)</p>
                        <input type="file" id="fileInput" multiple accept=".pdf,.jpg,.jpeg,.png,.txt" style="display: none;">
                    </div>
                    
                    <div class="uploaded-files" id="uploadedFiles">
                        <!-- Uploaded files will appear here -->
                    </div>
                    
                    <div class="form-group">
                        <label for="reportNotes">Notes (Optional)</label>
                        <textarea id="reportNotes" class="form-control" rows="3" 
                                  placeholder="Add any additional notes about the reports..."></textarea>
                    </div>
                </div>

                <!-- Step 5: Confirmation -->
                <div id="stepContent5" class="step-content">
                    <div class="confirmation-content">
                        <div class="success-icon">
                            <i class="fas fa-check"></i>
                        </div>
                        <h3>Appointment Booked Successfully!</h3>
                        <p>Your appointment has been confirmed. Here are the details:</p>
                        
                        <div id="confirmationDetails" class="detail-grid">
                            <!-- Confirmation details will be shown here -->
                        </div>
                        
                        <div style="margin-top: 2rem;">
                            <button class="btn btn-primary" onclick="nextStep()">
                                <i class="fas fa-credit-card"></i> Proceed to Payment
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Step 6: Payment -->
                <div id="stepContent6" class="step-content">
                    <h3>Payment</h3>
                    
                    <div class="payment-summary">
                        <h4>Payment Summary</h4>
                        <div id="appointmentSummary">
                            <!-- Appointment details will be shown here -->
                        </div>
                        <div class="payment-item">
                            <span>Consultation Fee:</span>
                            <span id="consultationFee">₹0</span>
                        </div>
                        <div class="payment-item payment-total">
                            <span>Total Amount:</span>
                            <span id="totalAmount">₹0</span>
                        </div>
                    </div>
                    
                    <button id="paymentButton" class="btn btn-primary" style="width: 100%;" onclick="processPayment()">
                        <i class="fas fa-credit-card"></i> Make Payment
                    </button>
                </div>

                <!-- Step Navigation -->
                <div class="step-navigation">
                    <button id="prevBtn" class="btn btn-secondary" onclick="previousStep()" style="display: none;">
                        <i class="fas fa-chevron-left"></i> Previous
                    </button>
                    <button id="nextBtn" class="btn btn-primary" onclick="nextStep()">
                        Next <i class="fas fa-chevron-right"></i>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://checkout.razorpay.com/v1/checkout.js"></script>
    <script>
        // Configuration
        const API_BASE_URL = 'http://localhost:8080/api/v1';
        
        // Global variables
        let currentPage = 0;
        let totalPages = 0;
        let currentFilters = {};
        let appointments = [];
        let searchTimeout = null;
        let allDoctors = [];
        
        // Booking flow variables - FIXED: Reset these properly
        let currentStep = 1;
        let selectedDoctor = null;
        let selectedDate = null;
        let selectedTimeSlot = null;
        let selectedPatient = null;
        let uploadedReports = [];
        let currentMonth = new Date();
        let appointment = null;
        let razorpayInstance = null; // FIXED: Track Razorpay instance
        let isPaymentInProgress = false; // FIXED: Track payment state

        // Initialize the application
        document.addEventListener('DOMContentLoaded', function() {
            loadAppointments();
            setupEventListeners();
        });

        // Setup event listeners
        function setupEventListeners() {
            // File upload
            const fileInput = document.getElementById('fileInput');
            const uploadArea = document.querySelector('.file-upload-area');
            
            if (fileInput) {
                fileInput.addEventListener('change', handleFileSelect);
            }
            
            if (uploadArea) {
                // Drag and drop
                uploadArea.addEventListener('dragover', handleDragOver);
                uploadArea.addEventListener('drop', handleFileDrop);
                uploadArea.addEventListener('dragleave', handleDragLeave);
            }
        }

        // FIXED: Complete booking flow reset function
        function resetBookingFlow() {
            console.log('Resetting booking flow...');
            
            // Reset step variables
            currentStep = 1;
            selectedDoctor = null;
            selectedDate = null;
            selectedTimeSlot = null;
            selectedPatient = null;
            uploadedReports = [];
            appointment = null;
            currentMonth = new Date();
            
            // FIXED: Reset payment state
            isPaymentInProgress = false;
            if (razorpayInstance) {
                razorpayInstance = null;
            }
            
            // Reset form inputs
            const inputs = document.querySelectorAll('#bookAppointmentModal input, #bookAppointmentModal select, #bookAppointmentModal textarea');
            inputs.forEach(input => {
                if (input.type === 'checkbox' || input.type === 'radio') {
                    input.checked = false;
                } else {
                    input.value = '';
                }
            });
            
            // Clear uploaded files display
            const uploadedFilesContainer = document.getElementById('uploadedFiles');
            if (uploadedFilesContainer) {
                uploadedFilesContainer.innerHTML = '';
            }
            
            // Clear patient suggestions
            const patientSuggestions = document.getElementById('patientSuggestions');
            if (patientSuggestions) {
                patientSuggestions.style.display = 'none';
                patientSuggestions.innerHTML = '';
            }
            
            // Clear doctor and time slot selections
            document.querySelectorAll('.doctor-card').forEach(card => {
                card.classList.remove('selected');
            });
            
            document.querySelectorAll('.time-slot').forEach(slot => {
                slot.classList.remove('selected');
            });
            
            document.querySelectorAll('.calendar-day').forEach(day => {
                day.classList.remove('selected');
            });
            
            // Reset step indicators
            resetSteps();
            
            console.log('Booking flow reset complete');
        }

        // Booking Flow Functions
        function startBookingFlow() {
            console.log('Starting booking flow...');
            
            // FIXED: Complete reset before starting
            resetBookingFlow();
            
            loadDoctorsForBooking();
            loadSpecialties();
            openModal('bookAppointmentModal');
        }

        function resetSteps() {
            // Reset step indicators
            for (let i = 1; i <= 6; i++) {
                const step = document.getElementById(`step${i}`);
                if (step) {
                    step.classList.remove('active', 'completed');
                }
                
                const content = document.getElementById(`stepContent${i}`);
                if (content) {
                    content.classList.remove('active');
                }
            }
            
            // Set first step as active
            const firstStep = document.getElementById('step1');
            const firstContent = document.getElementById('stepContent1');
            if (firstStep && firstContent) {
                firstStep.classList.add('active');
                firstContent.classList.add('active');
            }
            
            // Reset navigation buttons
            const prevBtn = document.getElementById('prevBtn');
            const nextBtn = document.getElementById('nextBtn');
            if (prevBtn) prevBtn.style.display = 'none';
            if (nextBtn) {
                nextBtn.style.display = 'block';
                nextBtn.disabled = false;
                nextBtn.innerHTML = 'Next <i class="fas fa-chevron-right"></i>';
            }
        }

        function nextStep() {
            if (!validateCurrentStep()) {
                return;
            }
            
            // Mark current step as completed
            const currentStepElement = document.getElementById(`step${currentStep}`);
            if (currentStepElement) {
                currentStepElement.classList.add('completed');
                currentStepElement.classList.remove('active');
            }
            
            currentStep++;
            
            if (currentStep <= 6) {
                showStep(currentStep);
                updateStepContent();
            }
        }

        function previousStep() {
            if (currentStep > 1) {
                // Remove active from current step
                const currentStepElement = document.getElementById(`step${currentStep}`);
                const currentContent = document.getElementById(`stepContent${currentStep}`);
                if (currentStepElement) currentStepElement.classList.remove('active');
                if (currentContent) currentContent.classList.remove('active');
                
                currentStep--;
                
                // Remove completed from previous step and make it active
                const prevStepElement = document.getElementById(`step${currentStep}`);
                const prevContent = document.getElementById(`stepContent${currentStep}`);
                if (prevStepElement) {
                    prevStepElement.classList.remove('completed');
                    prevStepElement.classList.add('active');
                }
                if (prevContent) {
                    prevContent.classList.add('active');
                }
                
                updateNavigationButtons();
            }
        }

        function showStep(step) {
            // Hide all step contents
            for (let i = 1; i <= 6; i++) {
                const content = document.getElementById(`stepContent${i}`);
                if (content) content.classList.remove('active');
            }
            
            // Show current step content
            const currentContent = document.getElementById(`stepContent${step}`);
            const currentStepElement = document.getElementById(`step${step}`);
            if (currentContent) currentContent.classList.add('active');
            if (currentStepElement) currentStepElement.classList.add('active');
            
            updateNavigationButtons();
        }

        function updateNavigationButtons() {
            const prevBtn = document.getElementById('prevBtn');
            const nextBtn = document.getElementById('nextBtn');
            
            if (!prevBtn || !nextBtn) return;
            
            // Show/hide previous button
            prevBtn.style.display = currentStep > 1 ? 'block' : 'none';
            
            // Update next button text based on current step
            if (currentStep === 6) {
                nextBtn.innerHTML = '<i class="fas fa-credit-card"></i> Make Payment';
            } else if (currentStep === 5) {
                nextBtn.innerHTML = 'Proceed to Payment <i class="fas fa-chevron-right"></i>';
            } else {
                nextBtn.innerHTML = 'Next <i class="fas fa-chevron-right"></i>';
            }
        }

        function updateStepContent() {
            switch (currentStep) {
                case 2:
                    generateCalendar();
                    break;
                case 3:
                    // Patient details step
                    break;
                case 4:
                    // Upload reports step - upload files if any
                    if (uploadedReports.length > 0) {
                        uploadReportsToServer();
                    }
                    break;
                case 5:
                    showConfirmation();
                    break;
                case 6:
                    updatePaymentSummary();
                    break;
            }
        }

        function validateCurrentStep() {
            switch (currentStep) {
                case 1:
                    if (!selectedDoctor) {
                        showError('Please select a doctor');
                        return false;
                    }
                    break;
                case 2:
                    if (!selectedDate || !selectedTimeSlot) {
                        showError('Please select a date and time slot');
                        return false;
                    }
                    break;
                case 3:
                    if (!selectedPatient && !validatePatientForm()) {
                        return false;
                    }
                    if (!selectedPatient) {
                        createPatientFromForm();
                    }
                    break;
                case 4:
                    // Reports are optional
                    break;
                case 5:
                    // Create appointment before going to payment
                    return createAppointmentBeforePayment();
                case 6:
                    // Payment validation will be handled in processPayment
                    break;
            }
            return true;
        }

        // Step 1: Doctor Selection
        async function loadDoctorsForBooking() {
            try {
                const response = await fetch(`${API_BASE_URL}/doctors?size=100`);
                const data = await response.json();
                allDoctors = data.content || [];
                
                displayDoctors(allDoctors);
                
            } catch (error) {
                console.error('Error loading doctors:', error);
                showError('Failed to load doctors');
            }
        }

        function displayDoctors(doctors) {
            const grid = document.getElementById('doctorsGrid');
            
            if (!grid) return;
            
            if (!doctors || doctors.length === 0) {
                grid.innerHTML = '<p>No doctors found</p>';
                return;
            }
            
            grid.innerHTML = doctors.map(doctor => `
                <div class="doctor-card" onclick="selectDoctor(${doctor.doctorId})">
                    <div class="doctor-header">
                        <div class="doctor-avatar">
                            ${doctor.fullName.charAt(0)}
                        </div>
                        <div class="doctor-info">
                            <h3>Dr. ${doctor.fullName}</h3>
                            <p>${doctor.specialization}</p>
                        </div>
                    </div>
                    <div class="doctor-details">
                        <span>Experience: ${doctor.experienceYears} years</span>
                        <span>Fees: ₹${doctor.fees}</span>
                        <span>Location: ${doctor.address}</span>
                        <div class="doctor-rating">
                            <i class="fas fa-star"></i>
                            <span>4.5</span>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        function selectDoctor(doctorId) {
            // Remove previous selection
            document.querySelectorAll('.doctor-card').forEach(card => {
                card.classList.remove('selected');
            });
            
            // Add selection to clicked card
            event.currentTarget.classList.add('selected');
            
            // Find and store selected doctor
            selectedDoctor = allDoctors.find(doctor => doctor.doctorId === doctorId);
            
            console.log('Selected doctor:', selectedDoctor);
        }

        function performSearch() {
            const query = document.getElementById('doctorSearch').value.trim().toLowerCase();
            
            if (query.length === 0) {
                displayDoctors(allDoctors);
                return;
            }
            
            const filteredDoctors = allDoctors.filter(doctor => {
                return (
                    (doctor.fullName && doctor.fullName.toLowerCase().includes(query)) ||
                    (doctor.specialization && doctor.specialization.toLowerCase().includes(query)) ||
                    (doctor.address && doctor.address.toLowerCase().includes(query))
                );
            });
            
            displayDoctors(filteredDoctors);
        }

        async function loadSpecialties() {
            try {
                // Load specialties
                const specialtiesResponse = await fetch(`${API_BASE_URL}/doctors/specialities`);
                const specialties = await specialtiesResponse.json();
                
                const specialtySelect = document.getElementById('specialtyFilter');
                if (specialtySelect) {
                    specialtySelect.innerHTML = '<option value="">All Specialties</option>';
                    
                    specialties.forEach(specialty => {
                        specialtySelect.innerHTML += `<option value="${specialty}">${specialty}</option>`;
                    });
                }
                
                // Load locations
                const locationsResponse = await fetch(`${API_BASE_URL}/doctors?size=100`);
                const locationData = await locationsResponse.json();
                const locations = [...new Set((locationData.content || []).map(doctor => doctor.address).filter(Boolean))];
                
                const locationSelect = document.getElementById('locationFilter');
                if (locationSelect) {
                    locationSelect.innerHTML = '<option value="">All Locations</option>';
                    
                    locations.forEach(location => {
                        locationSelect.innerHTML += `<option value="${location}">${location}</option>`;
                    });
                }
                
            } catch (error) {
                console.error('Error loading filters:', error);
            }
        }

        function filterDoctors() {
            const specialty = document.getElementById('specialtyFilter')?.value;
            const rating = document.getElementById('ratingFilter')?.value;
            const location = document.getElementById('locationFilter')?.value;
            
            let url = `${API_BASE_URL}/doctors?size=100`;
            
            if (specialty) {
                url = `${API_BASE_URL}/doctors/search?speciality=${encodeURIComponent(specialty)}&size=100`;
            }
            
            fetch(url)
                .then(response => response.json())
                .then(data => {
                    let doctors = data.content || [];
                    
                    // Filter by location if specified
                    if (location) {
                        doctors = doctors.filter(doctor => 
                            doctor.address && doctor.address.toLowerCase().includes(location.toLowerCase())
                        );
                    }
                    
                    // Filter by rating if specified (mock implementation)
                    if (rating) {
                        const minRating = parseFloat(rating);
                        doctors = doctors.filter(doctor => {
                            // Since we don't have rating in API, we'll use a mock rating based on experience
                            const mockRating = Math.min(5, 3 + (doctor.experienceYears || 0) * 0.1);
                            return mockRating >= minRating;
                        });
                    }
                    
                    displayDoctors(doctors);
                })
                .catch(error => {
                    console.error('Error filtering doctors:', error);
                    loadDoctorsForBooking();
                });
        }

        // Step 2: Schedule Appointment
        function generateCalendar() {
            const monthNames = [
                "January", "February", "March", "April", "May", "June",
                "July", "August", "September", "October", "November", "December"
            ];
            
            const dayNames = ["Sun", "Mon", "Tue", "Wed", "Thu", "Fri", "Sat"];
            
            const currentMonthElement = document.getElementById('currentMonth');
            if (currentMonthElement) {
                currentMonthElement.textContent = 
                    `${monthNames[currentMonth.getMonth()]} ${currentMonth.getFullYear()}`;
            }
            
            const grid = document.getElementById('calendarGrid');
            if (!grid) return;
            
            grid.innerHTML = '';
            
            // Add day headers
            dayNames.forEach(day => {
                const dayHeader = document.createElement('div');
                dayHeader.className = 'calendar-day-header';
                dayHeader.textContent = day;
                grid.appendChild(dayHeader);
            });
            
            // Get first day of month and number of days
            const firstDay = new Date(currentMonth.getFullYear(), currentMonth.getMonth(), 1);
            const lastDay = new Date(currentMonth.getFullYear(), currentMonth.getMonth() + 1, 0);
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            
            // Add empty cells for days before month starts
            for (let i = 0; i < firstDay.getDay(); i++) {
                const emptyDay = document.createElement('div');
                emptyDay.className = 'calendar-day other-month';
                grid.appendChild(emptyDay);
            }
            
            // Add days of the month
            for (let day = 1; day <= lastDay.getDate(); day++) {
                const dayElement = document.createElement('div');
                dayElement.className = 'calendar-day';
                dayElement.textContent = day;
                
                const currentDate = new Date(currentMonth.getFullYear(), currentMonth.getMonth(), day);
                currentDate.setHours(0, 0, 0, 0);
                
                // Disable past dates
                if (currentDate < today) {
                    dayElement.classList.add('disabled');
                } else {
                    dayElement.onclick = () => selectDate(currentDate);
                }
                
                grid.appendChild(dayElement);
            }
        }

        function selectDate(date) {
            // Remove previous selection
            document.querySelectorAll('.calendar-day').forEach(day => {
                day.classList.remove('selected');
            });
            
            // Add selection to clicked day
            event.target.classList.add('selected');
            
            selectedDate = date;
            loadTimeSlots(date);
        }

        async function loadTimeSlots(date) {
            if (!selectedDoctor) return;
            
            // Format date as YYYY-MM-DD in local timezone
            const year = date.getFullYear();
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const day = String(date.getDate()).padStart(2, '0');
            const dateString = `${year}-${month}-${day}`;
            
            console.log('Loading time slots for date:', dateString, 'Doctor ID:', selectedDoctor.doctorId);
            
            try {
                const response = await fetch(`${API_BASE_URL}/appointment-slots/doctor/${selectedDoctor.doctorId}/date/${dateString}`);
                const timeSlots = await response.json();
                
                displayTimeSlots(timeSlots);
                
            } catch (error) {
                console.error('Error loading time slots:', error);
                const timeSlotsContainer = document.getElementById('timeSlots');
                if (timeSlotsContainer) {
                    timeSlotsContainer.innerHTML = '<p>Error loading time slots</p>';
                }
            }
        }

        function displayTimeSlots(timeSlots) {
            const container = document.getElementById('timeSlots');
            if (!container) return;
            
            if (!timeSlots || timeSlots.length === 0) {
                container.innerHTML = '<p>No available time slots for this date</p>';
                return;
            }
            
            container.innerHTML = timeSlots.map(slot => `
                <div class="time-slot ${slot.isBooked ? 'disabled' : ''}" 
                     onclick="${slot.isBooked ? '' : `selectTimeSlot(${slot.id}, '${slot.startTime}', '${slot.endTime}')`}">
                    <span>${slot.startTime} - ${slot.endTime}</span>
                    <span>${slot.isBooked ? 'Booked' : 'Available'}</span>
                </div>
            `).join('');
        }

        function selectTimeSlot(slotId, startTime, endTime) {
            // Remove previous selection
            document.querySelectorAll('.time-slot').forEach(slot => {
                slot.classList.remove('selected');
            });
            
            // Add selection to clicked slot
            event.currentTarget.classList.add('selected');
            
            selectedTimeSlot = {
                id: slotId,
                startTime: startTime,
                endTime: endTime
            };
        }

        function previousMonth() {
            currentMonth.setMonth(currentMonth.getMonth() - 1);
            generateCalendar();
        }

        function nextMonth() {
            currentMonth.setMonth(currentMonth.getMonth() + 1);
            generateCalendar();
        }

        // Step 3: Patient Details
        async function searchPatients() {
            const query = document.getElementById('patientSearchInput')?.value.trim();
            
            if (!query || query.length < 2) {
                const suggestions = document.getElementById('patientSuggestions');
                if (suggestions) suggestions.style.display = 'none';
                return;
            }
            
            try {
                const response = await fetch(`${API_BASE_URL}/patients/search/by-name?name=${encodeURIComponent(query)}`);
                const patients = await response.json();
                
                displayPatientSuggestions(patients);
                
            } catch (error) {
                console.error('Error searching patients:', error);
            }
        }

        function displayPatientSuggestions(patients) {
            const container = document.getElementById('patientSuggestions');
            if (!container) return;
            
            if (!patients || patients.length === 0) {
                container.style.display = 'none';
                return;
            }
            
            container.innerHTML = patients.map(patient => `
                <div class="patient-suggestion" onclick="selectExistingPatient(${patient.patientId})">
                    <strong>${patient.fullName}</strong><br>
                    <small>${patient.phone} | ${patient.emailAddress}</small>
                </div>
            `).join('');
            
            container.style.display = 'block';
        }

        function selectExistingPatient(patientId) {
            fetch(`${API_BASE_URL}/patients/${patientId}`)
                .then(response => response.json())
                .then(patient => {
                    selectedPatient = patient;
                    
                    // Fill form with patient data
                    const fields = {
                        'patientName': patient.fullName,
                        'patientGender': patient.gender,
                        'patientDOB': patient.dateOfBirth,
                        'patientPhone': patient.phone,
                        'patientEmail': patient.emailAddress,
                        'patientAddress': patient.address
                    };
                    
                    Object.entries(fields).forEach(([id, value]) => {
                        const element = document.getElementById(id);
                        if (element && value) element.value = value;
                    });
                    
                    // Hide suggestions
                    const suggestions = document.getElementById('patientSuggestions');
                    const searchInput = document.getElementById('patientSearchInput');
                    if (suggestions) suggestions.style.display = 'none';
                    if (searchInput) searchInput.value = patient.fullName;
                })
                .catch(error => console.error('Error fetching patient details:', error));
        }

        function validatePatientForm() {
            const fields = ['patientName', 'patientGender', 'patientDOB', 'patientPhone', 'patientEmail', 'patientAddress'];
            
            for (const fieldId of fields) {
                const element = document.getElementById(fieldId);
                if (!element || !element.value.trim()) {
                    showError('Please fill in all required patient details');
                    return false;
                }
            }
            
            // Validate phone number
            const phone = document.getElementById('patientPhone')?.value.trim();
            if (phone && !/^\d{10}$/.test(phone)) {
                showError('Please enter a valid 10-digit phone number');
                return false;
            }
            
            // Validate email
            const email = document.getElementById('patientEmail')?.value.trim();
            if (email && !/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email)) {
                showError('Please enter a valid email address');
                return false;
            }
            
            return true;
        }

        function createPatientFromForm() {
            selectedPatient = {
                fullName: document.getElementById('patientName')?.value.trim(),
                gender: document.getElementById('patientGender')?.value,
                dateOfBirth: document.getElementById('patientDOB')?.value,
                phone: document.getElementById('patientPhone')?.value.trim(),
                emailAddress: document.getElementById('patientEmail')?.value.trim(),
                address: document.getElementById('patientAddress')?.value.trim(),
                role: 'PATIENT'
            };
        }

        // Step 4: Upload Reports
        function handleFileSelect(event) {
            const files = Array.from(event.target.files);
            processFiles(files);
        }

        function handleDragOver(event) {
            event.preventDefault();
            event.currentTarget.classList.add('dragover');
        }

        function handleFileDrop(event) {
            event.preventDefault();
            event.currentTarget.classList.remove('dragover');
            
            const files = Array.from(event.dataTransfer.files);
            processFiles(files);
        }

        function handleDragLeave(event) {
            event.currentTarget.classList.remove('dragover');
        }

        function processFiles(files) {
            files.forEach(file => {
                // Validate file
                if (!validateFile(file)) return;
                
                // Add to uploaded files
                uploadedReports.push(file);
                
                // Display file
                displayUploadedFile(file);
            });
        }

        function validateFile(file) {
            const allowedTypes = ['application/pdf', 'image/jpeg', 'image/jpg', 'image/png', 'text/plain'];
            const maxSize = 10 * 1024 * 1024; // 10MB
            
            if (!allowedTypes.includes(file.type)) {
                showError(`File type ${file.type} is not allowed`);
                return false;
            }
            
            if (file.size > maxSize) {
                showError(`File ${file.name} exceeds 10MB limit`);
                return false;
            }
            
            return true;
        }

        function displayUploadedFile(file) {
            const container = document.getElementById('uploadedFiles');
            if (!container) return;
            
            const fileElement = document.createElement('div');
            fileElement.className = 'uploaded-file';
            fileElement.innerHTML = `
                <div class="file-info">
                    <div class="file-icon">
                        <i class="fas fa-file"></i>
                    </div>
                    <div>
                        <strong>${file.name}</strong><br>
                        <small>${formatFileSize(file.size)}</small>
                    </div>
                </div>
                <button class="btn btn-sm btn-danger" onclick="removeFile('${file.name}')">
                    <i class="fas fa-times"></i>
                </button>
            `;
            
            container.appendChild(fileElement);
        }

        function removeFile(fileName) {
            uploadedReports = uploadedReports.filter(file => file.name !== fileName);
            
            // Remove from display
            const fileElements = document.querySelectorAll('.uploaded-file');
            fileElements.forEach(element => {
                if (element.textContent.includes(fileName)) {
                    element.remove();
                }
            });
        }

        async function uploadReportsToServer() {
            if (!appointment || uploadedReports.length === 0) return;
            
            try {
                for (const file of uploadedReports) {
                    const formData = new FormData();
                    formData.append('file', file);
                    formData.append('appointmentId', appointment.appointmentId);
                    formData.append('notes', document.getElementById('reportNotes')?.value || '');
                    
                    const response = await fetch(`${API_BASE_URL}/patient-appointment-reports/upload`, {
                        method: 'POST',
                        body: formData
                    });
                    
                    if (!response.ok) {
                        throw new Error(`Failed to upload ${file.name}`);
                    }
                }
                
                showSuccess('Reports uploaded successfully');
            } catch (error) {
                console.error('Error uploading reports:', error);
                showError('Failed to upload some reports');
            }
        }

        // Step 5: Confirmation
        function showConfirmation() {
            const detailsDiv = document.getElementById('confirmationDetails');
            if (!detailsDiv) return;
            
            detailsDiv.innerHTML = `
                <div class="detail-item">
                    <div class="detail-label">Doctor</div>
                    <div class="detail-value">Dr. ${selectedDoctor?.fullName || 'N/A'}</div>
                </div>
                <div class="detail-item">
                    <div class="detail-label">Patient</div>
                    <div class="detail-value">${selectedPatient?.fullName || 'N/A'}</div>
                </div>
                <div class="detail-item">
                    <div class="detail-label">Date & Time</div>
                    <div class="detail-value">${formatDate(selectedDate)} at ${selectedTimeSlot?.startTime || 'N/A'}</div>
                </div>
                <div class="detail-item">
                    <div class="detail-label">Consultation Fee</div>
                    <div class="detail-value">₹${selectedDoctor?.fees || 0}</div>
                </div>
                ${uploadedReports.length > 0 ? `
                <div class="detail-item">
                    <div class="detail-label">Reports Uploaded</div>
                    <div class="detail-value">${uploadedReports.length} file(s)</div>
                </div>
                ` : ''}
            `;
        }

        async function createAppointmentBeforePayment() {
            try {
                // First create patient if new
                let patientId = selectedPatient?.patientId;
                
                if (!patientId) {
                    const patientResponse = await fetch(`${API_BASE_URL}/patients/register`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify(selectedPatient)
                    });
                    
                    if (patientResponse.ok) {
                        const newPatient = await patientResponse.json();
                        patientId = newPatient.patientId;
                        selectedPatient.patientId = patientId;
                    } else {
                        throw new Error('Failed to create patient');
                    }
                }
                
                // Create appointment
                const appointmentData = {
                    userId: 1, // Admin user ID
                    doctorId: selectedDoctor.doctorId,
                    patientId: patientId,
                    timeSlotId: selectedTimeSlot.id,
                    appointmentDate: selectedDate.toISOString().split('T')[0],
                    appointmentTime: selectedTimeSlot.startTime,
                    paymentStatus: 'UNPAID'
                };
                
                const response = await fetch(`${API_BASE_URL}/appointments/book`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(appointmentData)
                });
                
                if (response.ok) {
                    appointment = await response.json();
                    return true;
                } else {
                    const error = await response.text();
                    throw new Error(error || 'Failed to create appointment');
                }
                
            } catch (error) {
                console.error('Error creating appointment:', error);
                showError('Failed to create appointment: ' + error.message);
                return false;
            }
        }

        // Step 6: Payment - FIXED VERSION
        function updatePaymentSummary() {
            const summaryDiv = document.getElementById('appointmentSummary');
            const feeSpan = document.getElementById('consultationFee');
            const totalSpan = document.getElementById('totalAmount');
            
            if (!summaryDiv || !feeSpan || !totalSpan) return;
            
            if (selectedDoctor && selectedDate && selectedTimeSlot && selectedPatient) {
                summaryDiv.innerHTML = `
                    <div class="detail-grid">
                        <div class="detail-item">
                            <div class="detail-label">Appointment ID</div>
                            <div class="detail-value">#${appointment?.appointmentId || 'Pending'}</div>
                        </div>
                        <div class="detail-item">
                            <div class="detail-label">Doctor</div>
                            <div class="detail-value">Dr. ${selectedDoctor.fullName}</div>
                        </div>
                        <div class="detail-item">
                            <div class="detail-label">Patient</div>
                            <div class="detail-value">${selectedPatient.fullName}</div>
                        </div>
                        <div class="detail-item">
                            <div class="detail-label">Date</div>
                            <div class="detail-value">${formatDate(selectedDate)}</div>
                        </div>
                        <div class="detail-item">
                            <div class="detail-label">Time</div>
                            <div class="detail-value">${selectedTimeSlot.startTime} - ${selectedTimeSlot.endTime}</div>
                        </div>
                    </div>
                `;
                
                const fee = selectedDoctor.fees || 0;
                feeSpan.textContent = `₹${fee}`;
                totalSpan.textContent = `₹${fee}`;
            }
        }

        // FIXED: Improved payment processing with proper state management
        async function processPayment() {
            // FIXED: Prevent multiple payment attempts
            if (isPaymentInProgress) {
                console.log('Payment already in progress, ignoring click');
                return;
            }
            
            try {
                if (!appointment) {
                    showError('No appointment found. Please try again.');
                    return;
                }
                
                // FIXED: Set payment in progress state
                isPaymentInProgress = true;
                const paymentButton = document.getElementById('paymentButton');
                if (paymentButton) {
                    paymentButton.disabled = true;
                    paymentButton.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Creating Order...';
                }
                
                console.log('Creating payment order for appointment:', appointment.appointmentId);
                
                // Create Razorpay order
                const orderResponse = await fetch(`${API_BASE_URL}/payments/create-order/${appointment.appointmentId}`, {
                    method: 'POST'
                });
                
                if (!orderResponse.ok) {
                    throw new Error('Failed to create payment order');
                }
                
                const orderData = await orderResponse.json();
                console.log('Payment order created:', orderData);
                
                // FIXED: Clean up any existing Razorpay instance
                if (razorpayInstance) {
                    razorpayInstance = null;
                }
                
                // Initialize Razorpay payment
                const options = {
                    key: 'rzp_test_THhTRc6X4f92p4',
                    amount: orderData.amount,
                    currency: orderData.currency || 'INR',
                    name: 'DocOnClick',
                    description: `Appointment with Dr. ${selectedDoctor.fullName}`,
                    order_id: orderData.orderId,
                    handler: async function(response) {
                        console.log('Razorpay payment success:', response);
                        await verifyPayment(appointment.appointmentId, response);
                    },
                    prefill: {
                        name: selectedPatient.fullName,
                        email: selectedPatient.emailAddress,
                        contact: selectedPatient.phone
                    },
                    theme: { color: '#2563eb' },
                    modal: {
                        ondismiss: function() {
                            console.log('Payment modal dismissed by user');
                            resetPaymentButton();
                        }
                    },
                    notes: {
                        appointmentId: appointment.appointmentId,
                        doctorId: selectedDoctor.doctorId,
                        patientId: selectedPatient.patientId || 0
                    }
                };
                
                if (paymentButton) {
                    paymentButton.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Opening Payment...';
                }
                
                // FIXED: Create new Razorpay instance
                razorpayInstance = new Razorpay(options);
                razorpayInstance.open();
                
            } catch (error) {
                console.error('Error processing payment:', error);
                showError('Payment processing failed: ' + error.message);
                resetPaymentButton();
            }
        }

        // FIXED: Helper function to reset payment button state
        function resetPaymentButton() {
            isPaymentInProgress = false;
            const paymentButton = document.getElementById('paymentButton');
            if (paymentButton) {
                paymentButton.disabled = false;
                paymentButton.innerHTML = '<i class="fas fa-credit-card"></i> Make Payment';
            }
        }

        async function verifyPayment(appointmentId, paymentResponse) {
            try {
                console.log('Verifying payment for appointment:', appointmentId);
                
                const verificationData = {
                    appointmentId: appointmentId,
                    razorpayPaymentId: paymentResponse.razorpay_payment_id,
                    razorpayOrderId: paymentResponse.razorpay_order_id,
                    razorpaySignature: paymentResponse.razorpay_signature
                };
                
                const response = await fetch(`${API_BASE_URL}/payments/process`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(verificationData)
                });
                
                if (response.ok) {
                    console.log('Payment verified successfully');
                    showSuccess('Payment successful! Appointment confirmed.');
                    
                    // FIXED: Clean up and close modal
                    setTimeout(() => {
                        closeBookingModal();
                        loadAppointments();
                    }, 2000);
                } else {
                    throw new Error('Payment verification failed');
                }
                
            } catch (error) {
                console.error('Error verifying payment:', error);
                showError('Payment verification failed');
                resetPaymentButton();
            }
        }

        function closeBookingModal() {
            console.log('Closing booking modal...');
            
            // FIXED: Reset all states when closing
            resetBookingFlow();
            closeModal('bookAppointmentModal');
        }

        // Original appointment management functions
        async function loadAppointments(page = 0) {
            try {
                showLoading();
                
                let url = `${API_BASE_URL}/appointments/filter?page=${page}&size=10`;
                
                // Add filters
                if (currentFilters.date) {
                    url += `&date=${currentFilters.date}`;
                }
                if (currentFilters.status) {
                    url += `&status=${currentFilters.status}`;
                }
                
                const response = await fetch(url);
                const data = await response.json();
                
                appointments = data.content || [];
                totalPages = data.totalPages || 0;
                currentPage = page;
                
                displayAppointments(appointments);
                updatePagination();
                
            } catch (error) {
                console.error('Error loading appointments:', error);
                showError('Failed to load appointments');
            }
        }

        // Search appointments
        async function searchAppointments(query, type) {
            try {
                showLoading();
                
                let url;
                if (type === 'id') {
                    // Search by appointment ID - we'll filter locally for now
                    await loadAppointments();
                    const filtered = appointments.filter(apt => 
                        apt.appointmentId.toString().includes(query)
                    );
                    displayAppointments(filtered);
                } else if (type === 'patient') {
                    url = `${API_BASE_URL}/appointments/search/patient?patientName=${encodeURIComponent(query)}&page=0&size=10`;
                    const response = await fetch(url);
                    const data = await response.json();
                    displayAppointments(data.content || []);
                }
                
            } catch (error) {
                console.error('Error searching appointments:', error);
                showError('Failed to search appointments');
            }
        }

        // Handle search input
        function handleSearch() {
            const appointmentId = document.getElementById('searchAppointmentId')?.value.trim();
            const patientName = document.getElementById('searchPatientName')?.value.trim();
            
            clearTimeout(searchTimeout);
            searchTimeout = setTimeout(() => {
                if (appointmentId) {
                    searchAppointments(appointmentId, 'id');
                } else if (patientName) {
                    searchAppointments(patientName, 'patient');
                } else {
                    loadAppointments();
                }
            }, 500);
        }

        // Handle filters
        function handleFilter() {
            const date = document.getElementById('filterDate')?.value;
            const status = document.getElementById('filterStatus')?.value;
            
            currentFilters = {
                date: date || null,
                status: status || null
            };
            
            loadAppointments(0);
        }

        // Clear filters
        function clearFilters() {
            const elements = ['searchAppointmentId', 'searchPatientName', 'filterDate', 'filterStatus'];
            elements.forEach(id => {
                const element = document.getElementById(id);
                if (element) element.value = '';
            });
            
            currentFilters = {};
            loadAppointments(0);
        }

        // Display appointments in table
        function displayAppointments(appointmentsList) {
            const tbody = document.getElementById('appointmentsTableBody');
            if (!tbody) return;
            
            if (!appointmentsList || appointmentsList.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="7" style="text-align: center; padding: 2rem; color: #6b7280;">
                            No appointments found
                        </td>
                    </tr>
                `;
                return;
            }
            
            tbody.innerHTML = appointmentsList.map(appointment => `
                <tr>
                    <td>#${appointment.appointmentId}</td>
                    <td>${appointment.patientName || 'N/A'}</td>
                    <td>Dr. ${appointment.doctorName || 'N/A'}</td>
                    <td>
                        ${formatDate(appointment.appointmentDate)}<br>
                        <small>${appointment.appointmentTime || 'N/A'}</small>
                    </td>
                    <td>
                        <span class="status-badge status-${appointment.appointmentStatus?.toLowerCase()}">
                            ${appointment.appointmentStatus || 'N/A'}
                        </span>
                    </td>
                    <td>
                        <span class="status-badge payment-${appointment.paymentStatus?.toLowerCase()}">
                            ${appointment.paymentStatus || 'N/A'}
                        </span>
                    </td>
                    <td>
                        <div class="actions">
                            <button class="btn btn-sm btn-primary" onclick="viewPatientDetails(${appointment.patientId || 0})" title="View Patient Details">
                                <i class="fas fa-user"></i>
                            </button>
                            <button class="btn btn-sm btn-secondary" onclick="viewPatientHistory(${appointment.patientId || 0}, ${appointment.doctorId || 0})" title="View Patient History">
                                <i class="fas fa-history"></i>
                            </button>
                            <button class="btn btn-sm btn-warning" onclick="viewUploadedDocuments(${appointment.appointmentId})" title="View Uploaded Documents">
                                <i class="fas fa-file-upload"></i>
                            </button>
                            <button class="btn btn-sm btn-success" onclick="viewReportsAndPrescriptions(${appointment.appointmentId})" title="View Reports & Prescriptions">
                                <i class="fas fa-prescription"></i>
                            </button>
                            <button class="btn btn-sm btn-danger" onclick="viewMedicalReports(${appointment.patientId || 0})" title="View Medical Reports">
                                <i class="fas fa-file-medical"></i>
                            </button>
                        </div>
                    </td>
                </tr>
            `).join('');
        }

        // Modal functions
        function openModal(modalId) {
            const modal = document.getElementById(modalId);
            if (modal) modal.style.display = 'block';
        }

        function closeModal(modalId) {
            const modal = document.getElementById(modalId);
            if (modal) modal.style.display = 'none';
        }

        // Pagination
        function updatePagination() {
            const paginationDiv = document.getElementById('pagination');
            if (!paginationDiv) return;
            
            if (totalPages <= 1) {
                paginationDiv.innerHTML = '';
                return;
            }
            
            let paginationHTML = '';
            
            // Previous button
            paginationHTML += `
                <button onclick="loadAppointments(${currentPage - 1})" ${currentPage === 0 ? 'disabled' : ''}>
                    <i class="fas fa-chevron-left"></i> Previous
                </button>
            `;
            
            // Page numbers
            for (let i = 0; i < totalPages; i++) {
                if (i === currentPage) {
                    paginationHTML += `<button class="active">${i + 1}</button>`;
                } else {
                    paginationHTML += `<button onclick="loadAppointments(${i})">${i + 1}</button>`;
                }
            }
            
            // Next button
            paginationHTML += `
                <button onclick="loadAppointments(${currentPage + 1})" ${currentPage === totalPages - 1 ? 'disabled' : ''}>
                    Next <i class="fas fa-chevron-right"></i>
                </button>
            `;
            
            paginationDiv.innerHTML = paginationHTML;
        }

        // Utility functions
        function showLoading() {
            const tbody = document.getElementById('appointmentsTableBody');
            if (tbody) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="7" class="loading">
                            <div class="spinner"></div>
                            Loading appointments...
                        </td>
                    </tr>
                `;
            }
        }

        function showSuccess(message) {
            const alert = document.createElement('div');
            alert.className = 'alert alert-success';
            alert.textContent = message;
            document.body.insertBefore(alert, document.body.firstChild);
            
            setTimeout(() => {
                alert.remove();
            }, 5000);
        }

        function showError(message) {
            const alert = document.createElement('div');
            alert.className = 'alert alert-error';
            alert.textContent = message;
            document.body.insertBefore(alert, document.body.firstChild);
            
            setTimeout(() => {
                alert.remove();
            }, 5000);
        }

        function formatDate(dateString) {
            if (!dateString) return 'N/A';
            return new Date(dateString).toLocaleDateString();
        }

        function formatDateTime(dateString) {
            if (!dateString) return 'N/A';
            return new Date(dateString).toLocaleString();
        }

        function formatFileSize(bytes) {
            if (!bytes) return 'N/A';
            const sizes = ['Bytes', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(1024));
            return Math.round(bytes / Math.pow(1024, i) * 100) / 100 + ' ' + sizes[i];
        }

        function getFileType(fileName) {
            if (!fileName) return 'Unknown';
            const extension = fileName.split('.').pop().toLowerCase();
            switch (extension) {
                case 'pdf': return 'PDF Document';
                case 'jpg':
                case 'jpeg': return 'JPEG Image';
                case 'png': return 'PNG Image';
                case 'txt': return 'Text Document';
                default: return 'Unknown';
            }
        }

        function refreshAppointments() {
            loadAppointments(currentPage);
        }

        function logout() {
            if (confirm('Are you sure you want to logout?')) {
                // Clear any stored session data
                localStorage.clear();
                sessionStorage.clear();
                
                // Redirect to login page
                window.location.href = 'login.html';
            }
        }

        // Close modals when clicking outside
        window.onclick = function(event) {
            const modals = document.querySelectorAll('.modal');
            modals.forEach(modal => {
                if (event.target === modal) {
                    modal.style.display = 'none';
                    
                    // FIXED: Reset booking flow if booking modal is closed
                    if (modal.id === 'bookAppointmentModal') {
                        resetBookingFlow();
                    }
                }
            });
        }

        // Placeholder functions for action buttons (simplified implementations)
        async function viewPatientDetails(patientId) {
            if (!patientId || patientId === 0) {
                showError('Patient ID not available');
                return;
            }
            
            try {
                const response = await fetch(`${API_BASE_URL}/patients/${patientId}/complete-details`);
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const patientDetails = await response.json();
                
                // Create a modal to display patient details
                const detailsModal = document.createElement('div');
                detailsModal.className = 'modal';
                detailsModal.style.display = 'block';
                detailsModal.innerHTML = `
                    <div class="modal-content">
                        <div class="modal-header">
                            <h2>Patient Details</h2>
                            <button class="close" onclick="this.closest('.modal').remove()">&times;</button>
                        </div>
                        <div class="modal-body">
                            <div class="detail-grid">
                                <div class="detail-item">
                                    <div class="detail-label">Full Name</div>
                                    <div class="detail-value">${patientDetails.fullName || 'N/A'}</div>
                                </div>
                                <div class="detail-item">
                                    <div class="detail-label">Email</div>
                                    <div class="detail-value">${patientDetails.emailAddress || 'N/A'}</div>
                                </div>
                                <div class="detail-item">
                                    <div class="detail-label">Phone</div>
                                    <div class="detail-value">${patientDetails.phone || 'N/A'}</div>
                                </div>
                                <div class="detail-item">
                                    <div class="detail-label">Date of Birth</div>
                                    <div class="detail-value">${formatDate(patientDetails.dateOfBirth)}</div>
                                </div>
                                <div class="detail-item">
                                    <div class="detail-label">Gender</div>
                                    <div class="detail-value">${patientDetails.gender || 'N/A'}</div>
                                </div>
                                <div class="detail-item">
                                    <div class="detail-label">Address</div>
                                    <div class="detail-value">${patientDetails.address || 'N/A'}</div>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
                
                document.body.appendChild(detailsModal);
                
            } catch (error) {
                console.error('Error fetching patient details:', error);
                showError('Failed to load patient details');
            }
        }

        async function viewPatientHistory(patientId, doctorId) {
            if (!patientId || patientId === 0) {
                showError('Patient ID not available');
                return;
            }
            
            const userId = doctorId || 1;
            
            try {
                const response = await fetch(`${API_BASE_URL}/appointments/patient/${patientId}/doctor/${userId}/history?page=0&size=20`);
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const historyData = await response.json();
                const history = historyData.content || historyData;
                
                const historyModal = document.createElement('div');
                historyModal.className = 'modal';
                historyModal.style.display = 'block';
                historyModal.innerHTML = `
                    <div class="modal-content">
                        <div class="modal-header">
                            <h2>Patient History</h2>
                            <button class="close" onclick="this.closest('.modal').remove()">&times;</button>
                        </div>
                        <div class="modal-body">
                            ${Array.isArray(history) && history.length > 0 ? `
                                <div class="table-container">
                                    <table class="table">
                                        <thead>
                                            <tr>
                                                <th>Date</th>
                                                <th>Doctor</th>
                                                <th>Status</th>
                                                <th>Notes</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            ${history.map(appointment => `
                                                <tr>
                                                    <td>${formatDate(appointment.appointmentDate)}</td>
                                                    <td>Dr. ${appointment.doctorName || 'N/A'}</td>
                                                    <td>
                                                        <span class="status-badge status-${appointment.appointmentStatus?.toLowerCase()}">
                                                            ${appointment.appointmentStatus || 'N/A'}
                                                        </span>
                                                    </td>
                                                    <td>${appointment.notes || 'No notes'}</td>
                                                </tr>
                                            `).join('')}
                                        </tbody>
                                    </table>
                                </div>
                            ` : '<p>No appointment history found for this patient.</p>'}
                        </div>
                    </div>
                `;
                
                document.body.appendChild(historyModal);
                
            } catch (error) {
                console.error('Error fetching patient history:', error);
                showError('Failed to load patient history');
            }
        }

        async function viewUploadedDocuments(appointmentId) {
            if (!appointmentId) {
                showError('Appointment ID not available');
                return;
            }
            
            try {
                const response = await fetch(`${API_BASE_URL}/patient-appointment-reports/appointment/${appointmentId}`);
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const documents = await response.json();
                
                const documentsModal = document.createElement('div');
                documentsModal.className = 'modal';
                documentsModal.style.display = 'block';
                documentsModal.innerHTML = `
                    <div class="modal-content">
                        <div class="modal-header">
                            <h2>Uploaded Documents</h2>
                            <button class="close" onclick="this.closest('.modal').remove()">&times;</button>
                        </div>
                        <div class="modal-body">
                            ${Array.isArray(documents) && documents.length > 0 ? `
                                <div class="uploaded-files">
                                    ${documents.map(doc => `
                                        <div class="file-display">
                                            <div class="file-info">
                                                <div class="file-icon">
                                                    <i class="fas fa-file"></i>
                                                </div>
                                                <div class="file-details">
                                                    <div class="file-name">${doc.fileName || doc.reportName || 'Document'}</div>
                                                    <div class="file-meta">
                                                        ${getFileType(doc.fileName || doc.reportName)} • 
                                                        ${doc.fileSize ? formatFileSize(doc.fileSize) : 'Unknown size'} • 
                                                        Uploaded: ${formatDateTime(doc.uploadedAt || doc.createdAt)}
                                                    </div>
                                                </div>
                                            </div>
                                            ${doc.fileUrl || doc.reportUrl ? `
                                                <button class="btn btn-sm btn-primary" onclick="window.open('${doc.fileUrl || doc.reportUrl}', '_blank')">
                                                    <i class="fas fa-eye"></i> View File
                                                </button>
                                            ` : ''}
                                        </div>
                                    `).join('')}
                                </div>
                            ` : '<p>No documents uploaded for this appointment.</p>'}
                        </div>
                    </div>
                `;
                
                document.body.appendChild(documentsModal);
                
            } catch (error) {
                console.error('Error fetching uploaded documents:', error);
                showError('Failed to load uploaded documents');
            }
        }

        async function viewReportsAndPrescriptions(appointmentId) {
            if (!appointmentId) {
                showError('Appointment ID not available');
                return;
            }
            
            try {
                const response = await fetch(`${API_BASE_URL}/prescriptions/appointment/${appointmentId}`);
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const prescriptions = await response.json();
                
                const prescriptionsModal = document.createElement('div');
                prescriptionsModal.className = 'modal';
                prescriptionsModal.style.display = 'block';
                prescriptionsModal.innerHTML = `
                    <div class="modal-content">
                        <div class="modal-header">
                            <h2>Reports & Prescriptions</h2>
                            <button class="close" onclick="this.closest('.modal').remove()">&times;</button>
                        </div>
                        <div class="modal-body">
                            ${Array.isArray(prescriptions) && prescriptions.length > 0 ? `
                                <div class="table-container">
                                    <table class="table">
                                        <thead>
                                            <tr>
                                                <th>Medicine</th>
                                                <th>Dosage</th>
                                                <th>Duration</th>
                                                <th>Instructions</th>
                                                <th>Date</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            ${prescriptions.map(prescription => `
                                                <tr>
                                                    <td>${prescription.medicineName || 'N/A'}</td>
                                                    <td>${prescription.dosage || 'N/A'}</td>
                                                    <td>${prescription.duration || 'N/A'}</td>
                                                    <td>${prescription.instructions || 'N/A'}</td>
                                                    <td>${formatDate(prescription.prescribedDate || prescription.createdAt)}</td>
                                                </tr>
                                            `).join('')}
                                        </tbody>
                                    </table>
                                </div>
                            ` : '<p>No prescriptions found for this appointment.</p>'}
                        </div>
                    </div>
                `;
                
                document.body.appendChild(prescriptionsModal);
                
            } catch (error) {
                console.error('Error fetching reports and prescriptions:', error);
                showError('Failed to load reports and prescriptions');
            }
        }

        async function viewMedicalReports(patientId) {
            if (!patientId || patientId === 0) {
                showError('Patient ID not available');
                return;
            }
            
            try {
                const response = await fetch(`${API_BASE_URL}/medical-reports/patient/${patientId}`);
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const medicalReports = await response.json();
                
                const reportsModal = document.createElement('div');
                reportsModal.className = 'modal';
                reportsModal.style.display = 'block';
                reportsModal.innerHTML = `
                    <div class="modal-content">
                        <div class="modal-header">
                            <h2>Medical Reports</h2>
                            <button class="close" onclick="this.closest('.modal').remove()">&times;</button>
                        </div>
                        <div class="modal-body">
                            ${Array.isArray(medicalReports) && medicalReports.length > 0 ? `
                                <div class="uploaded-files">
                                    ${medicalReports.map(report => `
                                        <div class="file-display">
                                            <div class="file-info">
                                                <div class="file-icon">
                                                    <i class="fas fa-file-medical"></i>
                                                </div>
                                                <div class="file-details">
                                                    <div class="file-name">${report.fileName || report.reportName || report.testName || 'Medical Report'}</div>
                                                    <div class="file-meta">
                                                        ${getFileType(report.fileName || report.reportName)} • 
                                                        ${report.fileSize ? formatFileSize(report.fileSize) : 'Unknown size'} • 
                                                        Date: ${formatDate(report.testDate || report.reportDate || report.createdAt)}
                                                        ${report.doctorName ? ` • Dr. ${report.doctorName}` : ''}
                                                    </div>
                                                    ${report.result || report.findings ? `
                                                        <div style="margin-top: 0.5rem; font-size: 0.875rem; color: #374151;">
                                                            <strong>Result:</strong> ${report.result || report.findings}
                                                        </div>
                                                    ` : ''}
                                                </div>
                                            </div>
                                            ${report.fileUrl ? `
                                                <button class="btn btn-sm btn-primary" onclick="window.open('${report.fileUrl}', '_blank')">
                                                    <i class="fas fa-eye"></i> View File
                                                </button>
                                            ` : ''}
                                        </div>
                                    `).join('')}
                                </div>
                            ` : '<p>No medical reports found for this patient.</p>'}
                        </div>
                    </div>
                `;
                
                document.body.appendChild(reportsModal);
                
            } catch (error) {
                console.error('Error fetching medical reports:', error);
                showError('Failed to load medical reports');
            }
        }
    </script>
</body>
</html>
