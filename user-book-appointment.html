<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Book Appointment - DocOnClick</title>
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css"
    />
    <link rel="stylesheet" href="css/user-book-appointment.css" />
    <link rel="stylesheet" href="css/nav.css" />
  </head>
  <body>
    <div class="main-header">
      <div class="container">
        <a href="home.html" class="logo">
          <div class="logo-icon">D</div>
          <div class="logo-text">DocOnClick</div>
        </a>
        <nav>
          <ul>
            <li><a href="home.html">Home</a></li>
            <li><a href="user-dashboard.html">Dashboard</a></li>
            <li><a href="user-appointments.html">My Appointments</a></li>
            <li><a href="#contact">Contact</a></li>
          </ul>
        </nav>
      </div>
    </div>
    <div class="container">
      <!-- Header -->
      <div class="header">
        <div class="user-info">
          <img
            src="/placeholder.svg?height=50&width=50"
            alt="User Avatar"
            class="user-avatar"
            id="userAvatar"
          />
          <div class="user-details">
            <h3 id="userName">Loading...</h3>
            <p id="userType">User</p>
          </div>
        </div>
        <div>
          <button class="btn btn-outline" onclick="logout()">
            <i class="fas fa-sign-out-alt"></i> Logout
          </button>
        </div>
      </div>

      <!-- Alert Messages -->
      <div class="alert alert-success" id="successAlert"></div>
      <div class="alert alert-error" id="errorAlert"></div>

      <!-- Progress Steps -->
      <div class="booking-steps">
        <div class="steps-container">
          <div class="progress-line">
            <div class="progress-fill" id="progressFill"></div>
          </div>
          <div class="step active" id="step-1">
            <div class="step-circle">1</div>
            <div class="step-label">Select Doctor</div>
          </div>
          <div class="step" id="step-2">
            <div class="step-circle">2</div>
            <div class="step-label">Schedule</div>
          </div>
          <div class="step" id="step-3">
            <div class="step-circle">3</div>
            <div class="step-label">Patient Details</div>
          </div>
          <div class="step" id="step-4">
            <div class="step-circle">4</div>
            <div class="step-label">Upload Reports</div>
          </div>
          <div class="step" id="step-5">
            <div class="step-circle">5</div>
            <div class="step-label">Payment</div>
          </div>
          <div class="step" id="step-6">
            <div class="step-circle">6</div>
            <div class="step-label">Confirmation</div>
          </div>
        </div>
      </div>

      <!-- Main Content -->
      <div class="booking-content">
        <!-- Step 1: Select Doctor -->
        <div class="step-content active" id="step-1-content">
          <div class="step-header">
            <h2>Find Your Doctor</h2>
            <p>
              Search and filter doctors to find the perfect healthcare
              professional for you
            </p>
          </div>

          <div class="search-section">
            <div class="search-container">
              <div class="search-input-wrapper">
                <input
                  type="text"
                  class="search-input"
                  id="mainSearch"
                  placeholder="Search by doctor name, speciality, or location..."
                  autocomplete="off"
                />
                <i class="fas fa-search search-icon"></i>
                <div class="search-suggestions" id="searchSuggestions"></div>
              </div>
              <button class="search-btn" onclick="performSearch()">
                <i class="fas fa-search"></i>
                Search
              </button>
            </div>

            <div class="filters-grid">
              <div class="filter-group">
                <label class="filter-label">Speciality</label>
                <select class="filter-select" id="speciality">
                  <option value="">All Specialities</option>
                </select>
              </div>
              <div class="filter-group">
                <label class="filter-label">Minimum Rating</label>
                <select class="filter-select" id="minRating">
                  <option value="">Any Rating</option>
                  <option value="4">4+ Stars</option>
                  <option value="3">3+ Stars</option>
                  <option value="2">2+ Stars</option>
                </select>
              </div>
              <div class="filter-group">
                <label class="filter-label">Location</label>
                <input
                  type="text"
                  class="filter-input"
                  id="location"
                  placeholder="Enter city or area"
                />
              </div>
              <div class="filter-group">
                <label class="filter-label">&nbsp;</label>
                <button class="clear-filters-btn" onclick="clearAllFilters()">
                  <i class="fas fa-times"></i> Clear Filters
                </button>
              </div>
            </div>
          </div>

          <div class="results-header">
            <div class="results-count" id="resultsCount">
              Loading doctors...
            </div>
            <div class="sort-container">
              <label class="sort-label">Sort by:</label>
              <select
                class="filter-select"
                id="sortBy"
                onchange="applySorting()"
              >
                <option value="name-asc">Name (A-Z)</option>
                <option value="name-desc">Name (Z-A)</option>
                <option value="rating-desc">Rating (High to Low)</option>
                <option value="rating-asc">Rating (Low to High)</option>
                <option value="experience-desc">
                  Experience (High to Low)
                </option>
                <option value="experience-asc">Experience (Low to High)</option>
                <option value="fees-asc">Fees (Low to High)</option>
                <option value="fees-desc">Fees (High to Low)</option>
              </select>
            </div>
          </div>

          <div id="doctorsContainer">
            <div class="loading">
              <div class="spinner"></div>
              <p>Loading doctors...</p>
            </div>
          </div>

          <div class="step-actions">
            <button
              class="btn btn-outline"
              onclick="window.location.href='index.html'"
            >
              <i class="fas fa-home"></i> Back to Home
            </button>
            <button class="btn btn-primary" id="nextToStep2" disabled>
              Next: Schedule <i class="fas fa-arrow-right"></i>
            </button>
          </div>
        </div>

        <!-- Step 2: Schedule -->
        <div class="step-content" id="step-2-content">
          <div class="step-header">
            <h2>Select Date & Time</h2>
            <p>Choose a convenient date and time for your appointment</p>
          </div>

          <div id="selectedDoctorInfo" class="summary-container">
            <!-- Selected doctor info will be displayed here -->
          </div>

          <div class="calendar-container">
            <div class="calendar-header">
              <button class="calendar-nav" id="prevMonth">
                <i class="fas fa-chevron-left"></i>
              </button>
              <h3 class="calendar-title" id="currentMonth">Loading...</h3>
              <button class="calendar-nav" id="nextMonth">
                <i class="fas fa-chevron-right"></i>
              </button>
            </div>
            <div class="calendar-grid" id="calendarGrid">
              <!-- Calendar will be generated here -->
            </div>
          </div>

          <div class="time-slots-container">
            <h3>Available Time Slots</h3>
            <div class="time-slots-grid" id="timeSlotsGrid">
              <p
                style="
                  text-align: center;
                  color: var(--text-secondary);
                  grid-column: 1/-1;
                "
              >
                Please select a date to view available time slots
              </p>
            </div>
          </div>

          <div class="step-actions">
            <button class="btn btn-outline" id="backToStep1">
              <i class="fas fa-arrow-left"></i> Back: Select Doctor
            </button>
            <button class="btn btn-primary" id="nextToStep3" disabled>
              Next: Patient Details <i class="fas fa-arrow-right"></i>
            </button>
          </div>
        </div>

        <!-- Step 3: Patient Details -->
        <div class="step-content" id="step-3-content">
          <div class="step-header">
            <h2>Patient Details</h2>
            <p>Provide information about the patient</p>
          </div>

          <div id="appointmentSummary" class="summary-container">
            <!-- Appointment summary will be displayed here -->
          </div>

          <div class="form-container">
            <div class="form-row">
              <div class="form-group">
                <label class="form-label" for="patientName">Full Name *</label>
                <input
                  type="text"
                  class="form-control"
                  id="patientName"
                  required
                />
              </div>
              <div class="form-group">
                <label class="form-label" for="patientGender">Gender *</label>
                <select class="form-control" id="patientGender" required>
                  <option value="">Select Gender</option>
                  <option value="MALE">Male</option>
                  <option value="FEMALE">Female</option>
                  <option value="OTHER">Other</option>
                </select>
              </div>
            </div>

            <div class="form-row">
              <div class="form-group">
                <label class="form-label" for="patientDOB"
                  >Date of Birth *</label
                >
                <input
                  type="date"
                  class="form-control"
                  id="patientDOB"
                  required
                />
              </div>
              <div class="form-group">
                <label class="form-label" for="patientPhone"
                  >Phone Number *</label
                >
                <input
                  type="tel"
                  class="form-control"
                  id="patientPhone"
                  required
                />
              </div>
            </div>

            <div class="form-group">
              <label class="form-label" for="patientEmail"
                >Email Address *</label
              >
              <input
                type="email"
                class="form-control"
                id="patientEmail"
                required
              />
            </div>

            <div class="form-group">
              <label class="form-label" for="patientAddress">Address *</label>
              <textarea
                class="form-control"
                id="patientAddress"
                rows="3"
                required
              ></textarea>
            </div>
          </div>

          <div class="step-actions">
            <button class="btn btn-outline" id="backToStep2">
              <i class="fas fa-arrow-left"></i> Back: Schedule
            </button>
            <button class="btn btn-primary" id="nextToStep4">
              Next: Upload Reports <i class="fas fa-arrow-right"></i>
            </button>
          </div>
        </div>

        <!-- Step 4: Upload Reports -->
        <div class="step-content" id="step-4-content">
          <div class="step-header">
            <h2>Upload Medical Reports</h2>
            <p>
              Upload any relevant medical reports, lab results, or prescriptions
              (Optional)
            </p>
          </div>

          <div id="reportsAppointmentSummary" class="summary-container">
            <!-- Appointment summary will be displayed here -->
          </div>

          <div class="file-upload-section">
            <div class="file-upload-area" id="fileUploadArea">
              <div class="file-upload-icon">
                <i class="fas fa-cloud-upload-alt"></i>
              </div>
              <h3>Drag & Drop Files Here</h3>
              <p>or click to browse files</p>
              <p
                style="
                  font-size: 0.875rem;
                  color: var(--text-muted);
                  margin-top: 0.75rem;
                "
              >
                Supported formats: PDF, JPG, PNG, TXT (Max 10MB per file)
              </p>
              <input
                type="file"
                id="fileInput"
                multiple
                accept=".pdf,.jpg,.jpeg,.png,.txt"
                style="display: none"
              />
            </div>

            <div class="uploaded-files" id="uploadedFiles">
              <!-- Uploaded files will be displayed here -->
            </div>

            <div class="form-group" style="margin-top: 1.5rem">
              <label class="form-label" for="reportsDescription"
                >Additional Notes (Optional)</label
              >
              <textarea
                class="form-control"
                id="reportsDescription"
                rows="3"
                placeholder="Add any additional information about the uploaded reports..."
              ></textarea>
            </div>
          </div>

          <div class="step-actions">
            <button class="btn btn-outline" id="backToStep3">
              <i class="fas fa-arrow-left"></i> Back: Patient Details
            </button>
            <button class="btn btn-primary" id="nextToStep5">
              Next: Payment <i class="fas fa-arrow-right"></i>
            </button>
          </div>
        </div>

        <!-- Step 5: Payment -->
        <div class="step-content" id="step-5-content">
          <div class="step-header">
            <h2>Payment</h2>
            <p>Complete your payment to confirm the appointment</p>
          </div>

          <div id="paymentSummary" class="summary-container">
            <!-- Payment summary will be displayed here -->
          </div>

          <div class="step-actions">
            <button class="btn btn-outline" id="backToStep4">
              <i class="fas fa-arrow-left"></i> Back: Upload Reports
            </button>
            <button class="btn btn-primary" id="makePayment">
              <i class="fas fa-credit-card"></i> Make Payment
            </button>
          </div>
        </div>

        <!-- Step 6: Confirmation -->
        <div class="step-content" id="step-6-content">
          <div class="confirmation-container">
            <div class="confirmation-icon">
              <i class="fas fa-check-circle"></i>
            </div>
            <h2>Appointment Confirmed!</h2>
            <p>Your appointment has been successfully booked</p>

            <div id="confirmationDetails" class="summary-container">
              <!-- Confirmation details will be displayed here -->
            </div>

            <div class="step-actions" style="justify-content: center">
              <button
                class="btn btn-primary"
                onclick="window.location.href='user-dashboard.html'"
              >
                <i class="fas fa-home"></i> Go to Dashboard
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>

    <script src="https://checkout.razorpay.com/v1/checkout.js"></script>
    <script>
      // Global variables
      let selectedDoctor = null;
      let selectedTimeSlot = null;
      let selectedDate = null;
      let currentPatient = null;
      let currentUser = null;
      let currentMonth = new Date().getMonth();
      let currentYear = new Date().getFullYear();
      let allDoctors = [];
      let filteredDoctors = [];
      let searchTimeout = null;
      let uploadedReports = [];
      let currentAppointmentId = null; // Store appointment ID for confirmation

      // API Base URL
      const API_BASE = "http://localhost:8080/api/v1";

      // Initialize the application
      document.addEventListener("DOMContentLoaded", function () {
        loadUserInfo();
        loadSpecialities();
        loadDoctors();
        initEventListeners();
        setupSearchFunctionality();
        setupFileUpload();
        updateProgressBar();
      });

      // Load user information from localStorage
      function loadUserInfo() {
        const userId = localStorage.getItem("userId");
        const userName = localStorage.getItem("userName");
        const userProfileImage = localStorage.getItem("userProfileImage");
        const userType = localStorage.getItem("userType");

        if (!userId) {
          window.location.href = "login.html";
          return;
        }

        currentUser = {
          userId: userId,
          userName: userName,
          userProfileImage: userProfileImage,
          userType: userType,
        };

        document.getElementById("userName").textContent = userName || "User";
        document.getElementById("userType").textContent = userType || "USER";

        const avatar = document.getElementById("userAvatar");
        if (userProfileImage) {
          avatar.src = userProfileImage;
        }
      }

      // Initialize event listeners
      function initEventListeners() {
        document
          .getElementById("nextToStep2")
          .addEventListener("click", () => goToStep(2));
        document
          .getElementById("backToStep1")
          .addEventListener("click", () => goToStep(1));
        document
          .getElementById("nextToStep3")
          .addEventListener("click", () => goToStep(3));
        document
          .getElementById("backToStep2")
          .addEventListener("click", () => goToStep(2));
        document
          .getElementById("nextToStep4")
          .addEventListener("click", () => goToStep(4));
        document
          .getElementById("backToStep3")
          .addEventListener("click", () => goToStep(3));
        document
          .getElementById("nextToStep5")
          .addEventListener("click", () => goToStep(5));
        document
          .getElementById("backToStep4")
          .addEventListener("click", () => goToStep(4));
        document
          .getElementById("makePayment")
          .addEventListener("click", processPayment);

        document
          .getElementById("prevMonth")
          .addEventListener("click", () => changeMonth(-1));
        document
          .getElementById("nextMonth")
          .addEventListener("click", () => changeMonth(1));

        // Filter change listeners
        document
          .getElementById("speciality")
          .addEventListener("change", performSearch);
        document
          .getElementById("minRating")
          .addEventListener("change", performSearch);
        document
          .getElementById("location")
          .addEventListener("input", debounceSearch);
      }

      // Setup file upload functionality
      function setupFileUpload() {
        const fileUploadArea = document.getElementById("fileUploadArea");
        const fileInput = document.getElementById("fileInput");

        // Click to upload
        fileUploadArea.addEventListener("click", () => {
          fileInput.click();
        });

        // File input change
        fileInput.addEventListener("change", (e) => {
          handleFiles(e.target.files);
        });

        // Drag and drop
        fileUploadArea.addEventListener("dragover", (e) => {
          e.preventDefault();
          fileUploadArea.classList.add("dragover");
        });

        fileUploadArea.addEventListener("dragleave", () => {
          fileUploadArea.classList.remove("dragover");
        });

        fileUploadArea.addEventListener("drop", (e) => {
          e.preventDefault();
          fileUploadArea.classList.remove("dragover");
          handleFiles(e.dataTransfer.files);
        });
      }

      // Handle file uploads
      function handleFiles(files) {
        Array.from(files).forEach((file) => {
          if (validateFile(file)) {
            uploadedReports.push({
              file: file,
              name: file.name,
              size: file.size,
              type: file.type,
              id: Date.now() + Math.random(), // Generate unique ID
            });
          }
        });
        displayUploadedFiles();
      }

      // Validate file
      function validateFile(file) {
        const allowedTypes = [
          "application/pdf",
          "image/jpeg",
          "image/jpg",
          "image/png",
          "text/plain",
        ];
        const maxSize = 10 * 1024 * 1024; // 10MB

        if (!allowedTypes.includes(file.type)) {
          showError(
            "File type not supported. Please upload PDF, JPG, PNG, or TXT files."
          );
          return false;
        }

        if (file.size > maxSize) {
          showError("File size exceeds 10MB limit.");
          return false;
        }

        return true;
      }

      // Display uploaded files
      function displayUploadedFiles() {
        const container = document.getElementById("uploadedFiles");

        if (uploadedReports.length === 0) {
          container.innerHTML = "";
          return;
        }

        container.innerHTML = uploadedReports
          .map(
            (report) => `
                <div class="uploaded-file" data-file-id="${report.id}">
                    <div class="file-info">
                        <div class="file-icon">
                            <i class="fas ${getFileIcon(report.type)}"></i>
                        </div>
                        <div class="file-details">
                            <div class="file-name">${report.name}</div>
                            <div class="file-size">${formatFileSize(
                              report.size
                            )}</div>
                        </div>
                    </div>
                    <div class="file-actions">
                        <button class="file-action-btn remove-file" onclick="removeFile('${
                          report.id
                        }')">
                            <i class="fas fa-trash"></i> Remove
                        </button>
                    </div>
                </div>
            `
          )
          .join("");
      }

      // Get file icon based on type
      function getFileIcon(type) {
        if (type.includes("pdf")) return "fa-file-pdf";
        if (type.includes("image")) return "fa-file-image";
        if (type.includes("text")) return "fa-file-alt";
        return "fa-file";
      }

      // Format file size
      function formatFileSize(bytes) {
        if (bytes === 0) return "0 Bytes";
        const k = 1024;
        const sizes = ["Bytes", "KB", "MB", "GB"];
        const i = Math.floor(Math.log(bytes) / Math.log(k));
        return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + " " + sizes[i];
      }

      // Remove file function
      function removeFile(fileId) {
        console.log("Removing file with ID:", fileId);

        // Remove from array
        uploadedReports = uploadedReports.filter(
          (report) => report.id.toString() !== fileId.toString()
        );

        console.log("Remaining files:", uploadedReports.length);

        // Update display
        displayUploadedFiles();

        // Show success message
        showSuccess("File removed successfully");
      }

      // Update progress bar
      function updateProgressBar() {
        const currentStep = document.querySelector(".step.active");
        if (currentStep) {
          const stepNumber = parseInt(currentStep.id.split("-")[1]);
          const progressPercentage = ((stepNumber - 1) / 5) * 100;
          document.getElementById("progressFill").style.width =
            progressPercentage + "%";
        }
      }

      // Setup search functionality
      function setupSearchFunctionality() {
        const searchInput = document.getElementById("mainSearch");
        const suggestionsDiv = document.getElementById("searchSuggestions");

        searchInput.addEventListener("input", function () {
          const query = this.value.trim();
          if (query.length > 0) {
            showSearchSuggestions(query);
            debounceSearch();
          } else {
            hideSuggestions();
            performSearch();
          }
        });

        searchInput.addEventListener("keypress", function (e) {
          if (e.key === "Enter") {
            performSearch();
            hideSuggestions();
          }
        });

        // Hide suggestions when clicking outside
        document.addEventListener("click", function (e) {
          if (
            !searchInput.contains(e.target) &&
            !suggestionsDiv.contains(e.target)
          ) {
            hideSuggestions();
          }
        });
      }

      // Debounced search function
      function debounceSearch() {
        clearTimeout(searchTimeout);
        searchTimeout = setTimeout(performSearch, 300);
      }

      // Show search suggestions
      function showSearchSuggestions(query) {
        const suggestionsDiv = document.getElementById("searchSuggestions");
        const suggestions = generateSuggestions(query);

        if (suggestions.length > 0) {
          suggestionsDiv.innerHTML = suggestions
            .map(
              (suggestion) =>
                `<div class="suggestion-item" onclick="selectSuggestion('${suggestion}')">${suggestion}</div>`
            )
            .join("");
          suggestionsDiv.style.display = "block";
        } else {
          hideSuggestions();
        }
      }

      // Generate search suggestions
      function generateSuggestions(query) {
        const suggestions = new Set();
        const queryLower = query.toLowerCase();

        // Add doctor name suggestions
        allDoctors.forEach((doctor) => {
          if (doctor.fullName.toLowerCase().includes(queryLower)) {
            suggestions.add(`Dr. ${doctor.fullName}`);
          }
          if (doctor.specialization.toLowerCase().includes(queryLower)) {
            suggestions.add(doctor.specialization);
          }
          const location = extractCityFromAddress(doctor.address);
          if (location.toLowerCase().includes(queryLower)) {
            suggestions.add(location);
          }
        });

        return Array.from(suggestions).slice(0, 5);
      }

      // Select suggestion
      function selectSuggestion(suggestion) {
        document.getElementById("mainSearch").value = suggestion;
        hideSuggestions();
        performSearch();
      }

      // Hide suggestions
      function hideSuggestions() {
        document.getElementById("searchSuggestions").style.display = "none";
      }

      // Load specialities
      async function loadSpecialities() {
        try {
          const response = await fetch(`${API_BASE}/doctors/specialities`);
          const specialities = await response.json();

          const select = document.getElementById("speciality");
          specialities.forEach((speciality) => {
            const option = document.createElement("option");
            option.value = speciality;
            option.textContent = speciality;
            select.appendChild(option);
          });
        } catch (error) {
          console.error("Error loading specialities:", error);
        }
      }

      // Load doctors
      async function loadDoctors() {
        showLoading(true);
        try {
          const response = await fetch(`${API_BASE}/doctors?size=100`);
          const data = await response.json();
          allDoctors = data.content || [];
          filteredDoctors = [...allDoctors];
          displayDoctors(filteredDoctors);
          updateResultsCount(filteredDoctors.length);
        } catch (error) {
          showError("Error loading doctors. Please try again.");
          console.error("Error loading doctors:", error);
        } finally {
          showLoading(false);
        }
      }

      // Perform search with all filters
      async function performSearch() {
        showLoading(true);

        const searchQuery = document.getElementById("mainSearch").value.trim();
        const speciality = document.getElementById("speciality").value;
        const minRating = document.getElementById("minRating").value;
        const location = document.getElementById("location").value.trim();

        try {
          let doctors = [...allDoctors];

          // Apply search query filter
          if (searchQuery) {
            doctors = doctors.filter((doctor) => {
              const nameMatch = doctor.fullName
                .toLowerCase()
                .includes(searchQuery.toLowerCase());
              const specialityMatch = doctor.specialization
                .toLowerCase()
                .includes(searchQuery.toLowerCase());
              const locationMatch = doctor.address
                .toLowerCase()
                .includes(searchQuery.toLowerCase());
              return nameMatch || specialityMatch || locationMatch;
            });
          }

          // Apply speciality filter
          if (speciality) {
            doctors = doctors.filter((doctor) =>
              doctor.specialization
                .toLowerCase()
                .includes(speciality.toLowerCase())
            );
          }

          // Apply location filter
          if (location) {
            doctors = doctors.filter((doctor) =>
              doctor.address.toLowerCase().includes(location.toLowerCase())
            );
          }

          // Apply rating filter
          if (minRating) {
            doctors = doctors.filter((doctor) => {
              const rating = doctor.averageRating || 0;
              return rating >= parseFloat(minRating);
            });
          }

          filteredDoctors = doctors;
          applySorting();
          updateResultsCount(filteredDoctors.length);
        } catch (error) {
          showError("Error searching doctors. Please try again.");
          console.error("Error searching doctors:", error);
        } finally {
          showLoading(false);
        }
      }

      // Apply sorting
      function applySorting() {
        const sortBy = document.getElementById("sortBy").value;
        let sortedDoctors = [...filteredDoctors];

        switch (sortBy) {
          case "name-asc":
            sortedDoctors.sort((a, b) => a.fullName.localeCompare(b.fullName));
            break;
          case "name-desc":
            sortedDoctors.sort((a, b) => b.fullName.localeCompare(a.fullName));
            break;
          case "rating-desc":
            sortedDoctors.sort(
              (a, b) => (b.averageRating || 0) - (a.averageRating || 0)
            );
            break;
          case "rating-asc":
            sortedDoctors.sort(
              (a, b) => (a.averageRating || 0) - (b.averageRating || 0)
            );
            break;
          case "experience-desc":
            sortedDoctors.sort(
              (a, b) => (b.experienceYears || 0) - (a.experienceYears || 0)
            );
            break;
          case "experience-asc":
            sortedDoctors.sort(
              (a, b) => (a.experienceYears || 0) - (b.experienceYears || 0)
            );
            break;
          case "fees-asc":
            sortedDoctors.sort((a, b) => (a.fees || 0) - (b.fees || 0));
            break;
          case "fees-desc":
            sortedDoctors.sort((a, b) => (b.fees || 0) - (a.fees || 0));
            break;
          default:
            break;
        }

        displayDoctors(sortedDoctors);
      }

      // Clear all filters
      function clearAllFilters() {
        document.getElementById("mainSearch").value = "";
        document.getElementById("speciality").value = "";
        document.getElementById("minRating").value = "";
        document.getElementById("location").value = "";
        document.getElementById("sortBy").value = "name-asc";

        filteredDoctors = [...allDoctors];
        applySorting();
        updateResultsCount(filteredDoctors.length);
        hideSuggestions();
      }

      // Update results count
      function updateResultsCount(count) {
        const resultsCount = document.getElementById("resultsCount");
        if (count === 0) {
          resultsCount.textContent = "No doctors found";
        } else if (count === 1) {
          resultsCount.textContent = "1 doctor found";
        } else {
          resultsCount.textContent = `${count} doctors found`;
        }
      }

      // Display doctors
      function displayDoctors(doctors) {
        const container = document.getElementById("doctorsContainer");

        if (doctors.length === 0) {
          container.innerHTML = `
                    <div style="text-align: center; padding: 3rem; color: var(--text-secondary);">
                        <i class="fas fa-search" style="font-size: 3rem; margin-bottom: 1rem; opacity: 0.5;"></i>
                        <h3>No doctors found</h3>
                        <p>Try adjusting your search criteria or filters</p>
                    </div>
                `;
          return;
        }

        const grid = document.createElement("div");
        grid.className = "doctors-grid";

        doctors.forEach((doctor) => {
          const doctorCard = createDoctorCard(doctor);
          grid.appendChild(doctorCard);
        });

        container.innerHTML = "";
        container.appendChild(grid);
      }

      // Create doctor card with enhanced information
      function createDoctorCard(doctor) {
        const card = document.createElement("div");
        card.className = "doctor-card";
        card.onclick = () => selectDoctor(doctor);

        const rating = doctor.averageRating || 0;
        const stars =
          "★".repeat(Math.floor(rating)) + "☆".repeat(5 - Math.floor(rating));
        const fees = doctor.fees || 500;
        const location = extractCityFromAddress(doctor.address);

        card.innerHTML = `
                <div class="doctor-header">
                    <img src="${
                      doctor.profileImage ||
                      "/placeholder.svg?height=60&width=60"
                    }" 
                         alt="Dr. ${doctor.fullName}" class="doctor-avatar">
                    <div class="doctor-info">
                        <h4>Dr. ${doctor.fullName}</h4>
                        <p>${doctor.specialization}</p>
                    </div>
                </div>
                <div class="doctor-details">
                    <div class="detail-item">
                        <i class="fas fa-graduation-cap"></i>
                        <span>${doctor.experienceYears || 0} years exp.</span>
                    </div>
                    <div class="detail-item">
                        <i class="fas fa-rupee-sign"></i>
                        <span>₹${fees}</span>
                    </div>
                    <div class="detail-item">
                        <i class="fas fa-map-marker-alt"></i>
                        <span>${location}</span>
                    </div>
                    <div class="detail-item">
                        <span style="color: #ffc107;">${stars}</span>
                        <span>(${rating.toFixed(1)})</span>
                    </div>
                </div>
            `;

        return card;
      }

      // Extract city from full address
      function extractCityFromAddress(address) {
        if (!address) return "Location not specified";

        const parts = address.split(",");
        if (parts.length >= 2) {
          return parts[parts.length - 2].trim();
        }
        return address.length > 20 ? address.substring(0, 20) + "..." : address;
      }

      // Load doctor details
      async function loadDoctorDetails(doctorId) {
        try {
          const response = await fetch(`${API_BASE}/doctors/${doctorId}`);
          if (response.ok) {
            const doctor = await response.json();
            if (!doctor.fees || doctor.fees === 0) {
              doctor.fees = 500;
            }
            return doctor;
          }
          throw new Error("Failed to load doctor details");
        } catch (error) {
          console.error("Error loading doctor details:", error);
          throw error;
        }
      }

      // Select doctor
      async function selectDoctor(doctor) {
        try {
          document.querySelectorAll(".doctor-card").forEach((card) => {
            card.classList.remove("selected");
          });

          event.currentTarget.classList.add("selected");

          const fullDoctorDetails = await loadDoctorDetails(doctor.doctorId);
          selectedDoctor = fullDoctorDetails;

          document.getElementById("nextToStep2").disabled = false;
        } catch (error) {
          showError("Error loading doctor details: " + error.message);
        }
      }

      // FIXED: Enhanced goToStep function with better validation and step management
      function goToStep(stepNumber) {
        console.log(`Attempting to go to step ${stepNumber}`);

        // Validation checks
        if (stepNumber === 2 && !selectedDoctor) {
          showError("Please select a doctor first.");
          return false;
        }

        if (stepNumber === 3 && (!selectedDate || !selectedTimeSlot)) {
          showError("Please select a date and time slot.");
          return false;
        }

        if (stepNumber === 4 && !validatePatientDetails()) {
          return false;
        }

        if (stepNumber === 5) {
          // Step 4 to 5 (Reports to Payment) - no validation needed as reports are optional
        }

        if (stepNumber === 6) {
          // Step 6 should only be reached after successful payment
          console.log("Moving to confirmation step");
        }

        // Update step visual indicators
        document.querySelectorAll(".step").forEach((step, index) => {
          step.classList.remove("active", "completed");
          if (index + 1 < stepNumber) {
            step.classList.add("completed");
          } else if (index + 1 === stepNumber) {
            step.classList.add("active");
          }
        });

        // Update step content visibility
        document.querySelectorAll(".step-content").forEach((content, index) => {
          content.classList.remove("active");
          if (index + 1 === stepNumber) {
            content.classList.add("active");
          }
        });

        // Update progress bar
        updateProgressBar();

        // Load step-specific content
        switch (stepNumber) {
          case 2:
            updateSelectedDoctorInfo();
            generateCalendar();
            break;
          case 3:
            updateAppointmentSummary();
            loadUserDetailsForForm();
            break;
          case 4:
            updateReportsAppointmentSummary();
            break;
          case 5:
            updatePaymentSummary();
            break;
          case 6:
            // Confirmation step - ensure we have appointment ID
            if (currentAppointmentId) {
              updateConfirmationDetails(currentAppointmentId);
            }
            break;
        }

        console.log(`Successfully moved to step ${stepNumber}`);
        return true;
      }

      // Update selected doctor info
      function updateSelectedDoctorInfo() {
        const container = document.getElementById("selectedDoctorInfo");
        container.innerHTML = `
                <h3 class="summary-title">Selected Doctor</h3>
                <div class="summary-item">
                    <span class="summary-label">Doctor:</span>
                    <span class="summary-value">Dr. ${
                      selectedDoctor.fullName
                    }</span>
                </div>
                <div class="summary-item">
                    <span class="summary-label">Specialization:</span>
                    <span class="summary-value">${
                      selectedDoctor.specialization
                    }</span>
                </div>
                <div class="summary-item">
                    <span class="summary-label">Experience:</span>
                    <span class="summary-value">${
                      selectedDoctor.experienceYears
                    } years</span>
                </div>
                <div class="summary-item">
                    <span class="summary-label">Location:</span>
                    <span class="summary-value">${extractCityFromAddress(
                      selectedDoctor.address
                    )}</span>
                </div>
                <div class="summary-item">
                    <span class="summary-label">Consultation Fee:</span>
                    <span class="summary-value">₹${selectedDoctor.fees}</span>
                </div>
            `;
      }

      // Generate calendar
      function generateCalendar() {
        const monthNames = [
          "January",
          "February",
          "March",
          "April",
          "May",
          "June",
          "July",
          "August",
          "September",
          "October",
          "November",
          "December",
        ];

        document.getElementById(
          "currentMonth"
        ).textContent = `${monthNames[currentMonth]} ${currentYear}`;

        const firstDay = new Date(currentYear, currentMonth, 1).getDay();
        const daysInMonth = new Date(
          currentYear,
          currentMonth + 1,
          0
        ).getDate();
        const today = new Date();

        const grid = document.getElementById("calendarGrid");
        grid.innerHTML = "";

        // Add day headers
        const dayHeaders = ["Sun", "Mon", "Tue", "Wed", "Thu", "Fri", "Sat"];
        dayHeaders.forEach((day) => {
          const header = document.createElement("div");
          header.textContent = day;
          header.style.fontWeight = "600";
          header.style.textAlign = "center";
          header.style.padding = "0.75rem";
          header.style.color = "var(--text-secondary)";
          header.style.fontSize = "0.875rem";
          header.style.background = "var(--secondary-color)";
          header.style.borderRadius = "var(--radius-sm)";
          grid.appendChild(header);
        });

        // Add empty cells for days before month starts
        for (let i = 0; i < firstDay; i++) {
          const emptyDay = document.createElement("div");
          grid.appendChild(emptyDay);
        }

        // Add days of the month
        for (let day = 1; day <= daysInMonth; day++) {
          const dayElement = document.createElement("div");
          dayElement.className = "calendar-day";
          dayElement.textContent = day;

          // Create the actual date object for this day
          const currentDate = new Date(currentYear, currentMonth, day);
          const todayDate = new Date();
          todayDate.setHours(0, 0, 0, 0); // Reset time to compare only dates

          // Store the actual date in the element for accurate selection
          dayElement.dataset.date = currentDate.toISOString().split("T")[0];
          dayElement.dataset.fullDate = currentDate.getTime();

          if (currentDate < todayDate) {
            dayElement.classList.add("disabled");
          } else {
            dayElement.addEventListener("click", () =>
              selectDate(currentDate, dayElement)
            );

            if (currentDate.getTime() === todayDate.getTime()) {
              dayElement.classList.add("today");
            }
          }

          grid.appendChild(dayElement);
        }
      }

      // Change month
      function changeMonth(direction) {
        currentMonth += direction;
        if (currentMonth < 0) {
          currentMonth = 11;
          currentYear--;
        } else if (currentMonth > 11) {
          currentMonth = 0;
          currentYear++;
        }
        generateCalendar();
      }

      // Select date function with proper timezone handling
      function selectDate(date, element) {
        // Remove previous selection
        document.querySelectorAll(".calendar-day").forEach((day) => {
          day.classList.remove("selected");
        });

        // Add selection to clicked element
        element.classList.add("selected");

        // Create a new date object in local timezone to avoid timezone conversion issues
        selectedDate = new Date(currentYear, currentMonth, date.getDate());

        // Debug logging
        console.log("Selected date:", selectedDate);
        console.log(
          "Formatted date for API:",
          selectedDate.toISOString().split("T")[0]
        );
        console.log(
          "Day of week:",
          selectedDate.toLocaleDateString("en-US", { weekday: "long" })
        );

        // Load time slots for the selected date
        loadTimeSlots();
      }

      // Load time slots
      async function loadTimeSlots() {
        if (!selectedDoctor || !selectedDate) return;

        // Use proper date formatting to avoid timezone issues
        const year = selectedDate.getFullYear();
        const month = String(selectedDate.getMonth() + 1).padStart(2, "0");
        const day = String(selectedDate.getDate()).padStart(2, "0");
        const formattedDate = `${year}-${month}-${day}`;

        const container = document.getElementById("timeSlotsGrid");

        console.log("Loading time slots for doctor:", selectedDoctor.doctorId);
        console.log("Loading time slots for date:", formattedDate);
        console.log("Selected date object:", selectedDate);

        container.innerHTML =
          '<div class="loading"><div class="spinner"></div><p>Loading time slots...</p></div>';

        try {
          const url = `${API_BASE}/appointment-slots/doctor/${selectedDoctor.doctorId}/date/${formattedDate}`;
          console.log("API URL:", url);

          const response = await fetch(url);
          console.log("Response status:", response.status);

          if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
          }

          const timeSlots = await response.json();
          console.log("Time slots received:", timeSlots);

          container.innerHTML = "";

          if (timeSlots.length === 0) {
            container.innerHTML =
              '<p style="text-align: center; color: var(--text-secondary); grid-column: 1/-1;">No available time slots for this date.</p>';
            return;
          }

          timeSlots.forEach((slot) => {
            const slotElement = document.createElement("div");
            slotElement.className = `time-slot ${
              slot.isBooked ? "disabled" : ""
            }`;
            slotElement.textContent = `${slot.startTime} - ${slot.endTime}`;

            if (!slot.isBooked) {
              slotElement.addEventListener("click", () => selectTimeSlot(slot));
            }

            container.appendChild(slotElement);
          });
        } catch (error) {
          console.error("Error loading time slots:", error);
          container.innerHTML =
            '<p style="text-align: center; color: var(--text-secondary); grid-column: 1/-1;">Error loading time slots. Please try again.</p>';
        }
      }

      // Select time slot
      function selectTimeSlot(slot) {
        document.querySelectorAll(".time-slot").forEach((element) => {
          element.classList.remove("selected");
        });

        event.currentTarget.classList.add("selected");

        selectedTimeSlot = slot;
        document.getElementById("nextToStep3").disabled = false;
      }

      // Update appointment summary
      function updateAppointmentSummary() {
        const container = document.getElementById("appointmentSummary");
        const formattedDate = selectedDate.toLocaleDateString("en-US", {
          weekday: "long",
          year: "numeric",
          month: "long",
          day: "numeric",
        });

        container.innerHTML = `
                <h3 class="summary-title">Appointment Summary</h3>
                <div class="summary-item">
                    <span class="summary-label">Doctor:</span>
                    <span class="summary-value">Dr. ${
                      selectedDoctor.fullName
                    }</span>
                </div>
                <div class="summary-item">
                    <span class="summary-label">Date:</span>
                    <span class="summary-value">${formattedDate}</span>
                </div>
                <div class="summary-item">
                    <span class="summary-label">Time:</span>
                    <span class="summary-value">${
                      selectedTimeSlot.startTime
                    } - ${selectedTimeSlot.endTime}</span>
                </div>
                <div class="summary-item">
                    <span class="summary-label">Location:</span>
                    <span class="summary-value">${extractCityFromAddress(
                      selectedDoctor.address
                    )}</span>
                </div>
                <div class="summary-item">
                    <span class="summary-label">Consultation Fee:</span>
                    <span class="summary-value">₹${selectedDoctor.fees}</span>
                </div>
            `;
      }

      // Update reports appointment summary
      function updateReportsAppointmentSummary() {
        const container = document.getElementById("reportsAppointmentSummary");
        const formattedDate = selectedDate.toLocaleDateString("en-US", {
          weekday: "long",
          year: "numeric",
          month: "long",
          day: "numeric",
        });

        container.innerHTML = `
                <h3 class="summary-title">Appointment Summary</h3>
                <div class="summary-item">
                    <span class="summary-label">Doctor:</span>
                    <span class="summary-value">Dr. ${
                      selectedDoctor.fullName
                    }</span>
                </div>
                <div class="summary-item">
                    <span class="summary-label">Patient:</span>
                    <span class="summary-value">${
                      document.getElementById("patientName").value
                    }</span>
                </div>
                <div class="summary-item">
                    <span class="summary-label">Date:</span>
                    <span class="summary-value">${formattedDate}</span>
                </div>
                <div class="summary-item">
                    <span class="summary-label">Time:</span>
                    <span class="summary-value">${
                      selectedTimeSlot.startTime
                    } - ${selectedTimeSlot.endTime}</span>
                </div>
                <div class="summary-item">
                    <span class="summary-label">Consultation Fee:</span>
                    <span class="summary-value">₹${selectedDoctor.fees}</span>
                </div>
            `;
      }

      // Load user details for form
      function loadUserDetailsForForm() {
        document.getElementById("patientName").value =
          currentUser.userName || "";
        document.getElementById("patientEmail").value = "";
        document.getElementById("patientPhone").value = "";
      }

      // Validate patient details
      function validatePatientDetails() {
        const name = document.getElementById("patientName").value.trim();
        const email = document.getElementById("patientEmail").value.trim();
        const phone = document.getElementById("patientPhone").value.trim();
        const gender = document.getElementById("patientGender").value;
        const dob = document.getElementById("patientDOB").value;
        const address = document.getElementById("patientAddress").value.trim();

        if (!name || !email || !phone || !gender || !dob || !address) {
          showError("Please fill in all required fields.");
          return false;
        }

        const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
        if (!emailRegex.test(email)) {
          showError("Please enter a valid email address.");
          return false;
        }

        const phoneRegex = /^\d{10}$/;
        if (!phoneRegex.test(phone.replace(/\D/g, ""))) {
          showError("Please enter a valid 10-digit phone number.");
          return false;
        }

        return true;
      }

      // Update payment summary
      function updatePaymentSummary() {
        const container = document.getElementById("paymentSummary");
        const formattedDate = selectedDate.toLocaleDateString("en-US", {
          weekday: "long",
          year: "numeric",
          month: "long",
          day: "numeric",
        });

        container.innerHTML = `
                <h3 class="summary-title">Payment Summary</h3>
                <div class="summary-item">
                    <span class="summary-label">Doctor:</span>
                    <span class="summary-value">Dr. ${
                      selectedDoctor.fullName
                    }</span>
                </div>
                <div class="summary-item">
                    <span class="summary-label">Date & Time:</span>
                    <span class="summary-value">${formattedDate} at ${
          selectedTimeSlot.startTime
        }</span>
                </div>
                <div class="summary-item">
                    <span class="summary-label">Patient:</span>
                    <span class="summary-value">${
                      document.getElementById("patientName").value
                    }</span>
                </div>
                <div class="summary-item">
                    <span class="summary-label">Location:</span>
                    <span class="summary-value">${extractCityFromAddress(
                      selectedDoctor.address
                    )}</span>
                </div>
                <div class="summary-item">
                    <span class="summary-label">Reports Uploaded:</span>
                    <span class="summary-value">${
                      uploadedReports.length
                    } file(s)</span>
                </div>
                <div class="summary-item">
                    <span class="summary-label">Consultation Fee:</span>
                    <span class="summary-value">₹${selectedDoctor.fees}</span>
                </div>
            `;
      }

      // FIXED: Enhanced processPayment function with better error handling and step transition
      async function processPayment() {
        const paymentButton = document.getElementById("makePayment");
        paymentButton.disabled = true;
        paymentButton.innerHTML =
          '<i class="fas fa-spinner fa-spin"></i> Processing...';

        try {
          console.log("Starting payment process...");

          // Step 1: Register the patient first
          const patientData = {
            fullName: document.getElementById("patientName").value,
            gender: document.getElementById("patientGender").value,
            dateOfBirth: document.getElementById("patientDOB").value,
            phone: document.getElementById("patientPhone").value,
            emailAddress: document.getElementById("patientEmail").value,
            address: document.getElementById("patientAddress").value,
            role: "PATIENT",
          };

          console.log("Registering patient:", patientData);
          const patientResponse = await fetch(`${API_BASE}/patients/register`, {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
              Accept: "application/json",
            },
            body: JSON.stringify(patientData),
          });

          if (!patientResponse.ok) {
            const errorText = await patientResponse.text();
            throw new Error(`Failed to register patient: ${errorText}`);
          }

          const patient = await patientResponse.json();
          currentPatient = patient;
          console.log("Patient registered successfully:", patient);

          // Step 2: Book the appointment
          const year = selectedDate.getFullYear();
          const month = String(selectedDate.getMonth() + 1).padStart(2, "0");
          const day = String(selectedDate.getDate()).padStart(2, "0");
          const appointmentDateFormatted = `${year}-${month}-${day}`;

          const appointmentData = {
            userId: parseInt(currentUser.userId),
            doctorId: selectedDoctor.doctorId,
            patientId: patient.patientId,
            timeSlotId: selectedTimeSlot.id,
            appointmentDate: appointmentDateFormatted,
            appointmentTime: selectedTimeSlot.startTime,
            paymentStatus: "UNPAID",
          };

          console.log("Booking appointment:", appointmentData);
          const appointmentResponse = await fetch(
            `${API_BASE}/appointments/book`,
            {
              method: "POST",
              headers: {
                "Content-Type": "application/json",
                Accept: "application/json",
              },
              body: JSON.stringify(appointmentData),
            }
          );

          if (!appointmentResponse.ok) {
            const errorText = await appointmentResponse.text();
            throw new Error(`Failed to book appointment: ${errorText}`);
          }

          const appointment = await appointmentResponse.json();
          currentAppointmentId = appointment.appointmentId; // Store appointment ID
          console.log("Appointment booked successfully:", appointment);

          // Step 3: Upload reports if any
          if (uploadedReports.length > 0) {
            console.log("Uploading reports...");
            for (const report of uploadedReports) {
              try {
                const formData = new FormData();
                formData.append("appointmentId", appointment.appointmentId);
                formData.append("file", report.file);
                formData.append(
                  "description",
                  document.getElementById("reportsDescription").value ||
                    "Patient uploaded report"
                );

                const reportResponse = await fetch(
                  `${API_BASE}/patient-appointment-reports/upload`,
                  {
                    method: "POST",
                    body: formData,
                  }
                );

                if (!reportResponse.ok) {
                  console.error("Failed to upload report:", report.name);
                } else {
                  console.log("Report uploaded successfully:", report.name);
                }
              } catch (reportError) {
                console.error(
                  "Error uploading report:",
                  report.name,
                  reportError
                );
              }
            }
          }

          // Step 4: Create payment order
          console.log(
            "Creating payment order for appointment:",
            appointment.appointmentId
          );
          const orderResponse = await fetch(
            `${API_BASE}/payments/create-order/${appointment.appointmentId}`,
            {
              method: "POST",
              headers: {
                "Content-Type": "application/json",
                Accept: "application/json",
              },
            }
          );

          if (!orderResponse.ok) {
            const errorText = await orderResponse.text();
            throw new Error(`Failed to create payment order: ${errorText}`);
          }

          const orderData = await orderResponse.json();
          console.log("Payment order created successfully:", orderData);

          // Step 5: Initialize Razorpay payment
          const options = {
            key: "rzp_test_THhTRc6X4f92p4",
            amount: orderData.amount,
            currency: orderData.currency || "INR",
            name: "DocOnClick",
            description: `Appointment with Dr. ${selectedDoctor.fullName}`,
            order_id: orderData.orderId,
            handler: async function (response) {
              console.log("Razorpay payment successful:", response);
              await verifyPayment(appointment.appointmentId, response);
            },
            prefill: {
              name: patient.fullName,
              email: patient.emailAddress,
              contact: patient.phone,
            },
            theme: {
              color: "#2563eb",
            },
            modal: {
              ondismiss: function () {
                console.log("Payment modal dismissed by user");
                paymentButton.disabled = false;
                paymentButton.innerHTML =
                  '<i class="fas fa-credit-card"></i> Make Payment';
              },
            },
          };

          console.log("Opening Razorpay payment gateway...");
          const rzp = new Razorpay(options);
          rzp.open();
        } catch (error) {
          console.error("Error in payment process:", error);
          showError("Error processing payment: " + error.message);
          paymentButton.disabled = false;
          paymentButton.innerHTML =
            '<i class="fas fa-credit-card"></i> Make Payment';
        }
      }

      // FIXED: Enhanced verifyPayment function with proper step transition
      async function verifyPayment(appointmentId, paymentResponse) {
        try {
          console.log("Starting payment verification...");
          console.log("Appointment ID:", appointmentId);
          console.log("Payment response:", paymentResponse);

          const paymentData = {
            appointmentId: appointmentId,
            razorpayPaymentId: paymentResponse.razorpay_payment_id,
            razorpayOrderId: paymentResponse.razorpay_order_id,
            razorpaySignature: paymentResponse.razorpay_signature,
          };

          console.log("Sending payment verification request:", paymentData);
          const response = await fetch(`${API_BASE}/payments/process`, {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
              Accept: "application/json",
            },
            body: JSON.stringify(paymentData),
          });

          console.log("Payment verification response status:", response.status);

          if (response.ok) {
            const result = await response.json();
            console.log("Payment verification successful:", result);

            // Store the appointment ID for confirmation
            currentAppointmentId = appointmentId;

            // Show success message
            showSuccess("Payment successful! Redirecting to confirmation...");

            // Small delay to show success message, then move to confirmation
            setTimeout(() => {
              console.log("Moving to confirmation step...");
              const success = goToStep(6);
              if (success) {
                console.log("Successfully moved to confirmation step");
              } else {
                console.error("Failed to move to confirmation step");
              }
            }, 1500);
          } else {
            const errorText = await response.text();
            console.error("Payment verification failed:", errorText);
            showError("Payment verification failed: " + errorText);

            // Reset payment button
            const paymentButton = document.getElementById("makePayment");
            paymentButton.disabled = false;
            paymentButton.innerHTML =
              '<i class="fas fa-credit-card"></i> Make Payment';
          }
        } catch (error) {
          console.error("Error verifying payment:", error);
          showError("Error verifying payment: " + error.message);

          // Reset payment button
          const paymentButton = document.getElementById("makePayment");
          paymentButton.disabled = false;
          paymentButton.innerHTML =
            '<i class="fas fa-credit-card"></i> Make Payment';
        }
      }

      // FIXED: Enhanced updateConfirmationDetails function
      function updateConfirmationDetails(appointmentId) {
        console.log(
          "Updating confirmation details for appointment:",
          appointmentId
        );

        const container = document.getElementById("confirmationDetails");
        const formattedDate = selectedDate.toLocaleDateString("en-US", {
          weekday: "long",
          year: "numeric",
          month: "long",
          day: "numeric",
        });

        container.innerHTML = `
                <h3 class="summary-title">Appointment Details</h3>
                <div class="summary-item">
                    <span class="summary-label">Appointment ID:</span>
                    <span class="summary-value">#${appointmentId}</span>
                </div>
                <div class="summary-item">
                    <span class="summary-label">Doctor:</span>
                    <span class="summary-value">Dr. ${
                      selectedDoctor.fullName
                    }</span>
                </div>
                <div class="summary-item">
                    <span class="summary-label">Date & Time:</span>
                    <span class="summary-value">${formattedDate} at ${
          selectedTimeSlot.startTime
        }</span>
                </div>
                <div class="summary-item">
                    <span class="summary-label">Patient:</span>
                    <span class="summary-value">${
                      document.getElementById("patientName").value
                    }</span>
                </div>
                <div class="summary-item">
                    <span class="summary-label">Location:</span>
                    <span class="summary-value">${extractCityFromAddress(
                      selectedDoctor.address
                    )}</span>
                </div>

                <div class="summary-item">
                    <span class="summary-label">Status:</span>
                    <span class="summary-value" style="color: #10b981; font-weight: 600;">✓ Confirmed & Paid</span>
                </div>
            `;

        console.log("Confirmation details updated successfully");
      }

      // Utility functions
      function showLoading(show) {
        const container = document.getElementById("doctorsContainer");
        if (show) {
          container.innerHTML =
            '<div class="loading"><div class="spinner"></div><p>Loading doctors...</p></div>';
        }
      }

      function showSuccess(message) {
        const alert = document.getElementById("successAlert");
        alert.textContent = message;
        alert.style.display = "block";
        setTimeout(() => (alert.style.display = "none"), 5000);
      }

      function showError(message) {
        const alert = document.getElementById("errorAlert");
        alert.textContent = message;
        alert.style.display = "block";
        setTimeout(() => (alert.style.display = "none"), 5000);
      }

      function logout() {
        localStorage.clear();
        window.location.href = "login.html";
      }
    </script>
  </body>
</html>
